# High availability configuration example
# This demonstrates a highly available setup with redundancy and resilience

## Multiple replicas with anti-affinity
replicaCount: 3

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

## Application Configuration
config:
  existingSecret: "paperless-secrets"
  url: "https://paperless.example.com"
  csrfTrustedOrigins:
    - "https://paperless.example.com"
  timeZone: "UTC"
  forceScriptName: "/paperless"
  staticUrl: "/paperless/static/"
  trustedProxies:
    - "10.1.0.0/16"
  proxySslHeader:
    - "HTTP_X_FORWARDED_PROTO"
    - "https"
  redirectLoginToSSO: true
  enableHttpRemoteUser: true
  enableHttpRemoteUserAPI: true
  httpRemoteUserHeaderName: "HTTP_X_REMOTE_USER"
  consumerSubdirsAsTags: true
  consumerRecursive: true
  consumerPolling: 5
  consumerPollingRetryCount: 8
  consumerPollingDelay: 3
  enableNltk: true
  dateParserLanguages: "en+fr"
  accountAllowSignups: false
  accountDefaultGroups:
    - "knowledge-workers"
  socialAccountSyncGroups: true

  # Optimized for HA
  webserverWorkers: 4
  taskWorkers: 2
  threadsPerWorker: 2
  workerTimeout: 900

## Database with HA endpoint
database:
  postgresql:
    host: "postgresql-ha.database.svc.cluster.local"
    port: 5432
    database: "paperless"
    username: "paperless"
    existingSecret: "paperless-secrets"
    passwordKey: "database-password"
    sslMode: "require"
    poolSize: 20
    timeout: 20
  readCache:
    enabled: true
    ttl: 3600
    redisUrl: "redis://redis-readcache.cache.svc.cluster.local:6379/3"

## Redis with Sentinel
redis:
  enabled: false
  host: "redis-ha-haproxy.database.svc.cluster.local"
  port: 6379
  prefix: "paperless:ha"
  existingSecret: "paperless-secrets"
  passwordKey: "redis-password"
  ssl: true

## Multiple workers for processing
worker:
  enabled: true
  replicaCount: 5

  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 512Mi

  # Distribute workers across nodes
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/component
                operator: In
                values:
                  - worker
          topologyKey: kubernetes.io/hostname

## Persistence with redundancy
persistence:
  data:
    enabled: true
    storageClass: "replicated-ssd"
    size: 50Gi

  media:
    enabled: true
    storageClass: "replicated-hdd"
    size: 200Gi

  consume:
    enabled: true
    storageClass: "replicated-ssd"
    size: 50Gi

## Service configuration
service:
  type: ClusterIP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

## Ingress with multiple replicas
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
  hosts:
    - host: paperless.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: paperless-tls
      hosts:
        - paperless.example.com

## Resource limits for stability
resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

## Pod Disruption Budget - ensure at least 2 pods always running
podDisruptionBudget:
  enabled: true
  minAvailable: 2

## Autoscaling
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 15
  targetCPU: 70
  targetMemory: 80

## Health checks with reasonable timeouts
livenessProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

readinessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30

## Anti-affinity to spread pods across nodes
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
                - paperless-ngx
            - key: app.kubernetes.io/component
              operator: In
              values:
                - webserver
        topologyKey: kubernetes.io/hostname
    # Prefer to run on different availability zones
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - paperless-ngx
          topologyKey: topology.kubernetes.io/zone

## Network policy for security
networkPolicy:
  enabled: true
  allowExternal: true

## Scheduled tasks tuned for HA
tasks:
  email: "*/5 * * * *"
  train: "*/30 * * * *"
  index: "0 * * * *"
  sanity: "0 0 * * sun"
  emptyTrash: "0 3 * * *"

## Optional services
tika:
  enabled: true
  endpoint: "http://tika-internal.apps.svc.cluster.local:9998"
  gotenbergEndpoint: "http://gotenberg.apps.svc.cluster.local:3000"

emailParsing:
  defaultLayout: 2

## Monitoring
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
