apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "compass-web.fullname" . }}-test-connection"
  namespace: {{ include "compass-web.namespace" . }}
  labels:
    {{- include "compass-web.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
    - name: test-connection
      image: curlimages/curl:latest
      command:
        - /bin/sh
        - -c
        - |
          echo "Testing Compass Web connection..."

          # Test 1: Health check - main page loads
          echo "Test 1: Checking root endpoint..."
          if curl -f -s --max-time 10 "{{ include "compass-web.fullname" . }}:{{ .Values.service.port }}/" > /dev/null; then
            echo "✓ Health check passed"
          else
            echo "✗ Health check failed"
            exit 1
          fi

          # Test 2: Check service is responding
          echo "Test 2: Checking service response..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "{{ include "compass-web.fullname" . }}:{{ .Values.service.port }}/")
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 401 ]; then
            echo "✓ Service responding (HTTP $RESPONSE)"
          else
            echo "✗ Unexpected response code: $RESPONSE"
            exit 1
          fi

          echo "All tests passed! ✓"
  restartPolicy: Never
