apiVersion: v1
kind: Pod
metadata:
  name: {{ include "restic-backup.name" . }}-test-secrets
  namespace: {{ include "restic-backup.namespace" . }}
  labels:
    {{- include "restic-backup.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  restartPolicy: Never
  serviceAccountName: {{ include "restic-backup.serviceAccountName" . }}
  containers:
    - name: test-secrets
      image: bitnami/kubectl:latest
      command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Testing secrets configuration..."

          # Test 1: Check if secret exists
          echo "Test 1: Checking if secret exists..."
          SECRET_NAME="{{ include "restic-backup.secretName" . }}"

          if kubectl get secret ${SECRET_NAME} -n {{ include "restic-backup.namespace" . }} > /dev/null 2>&1; then
            echo "✓ Secret exists"
          else
            echo "✗ Secret does not exist"
            exit 1
          fi

          # Test 2: Verify required keys
          echo "Test 2: Verifying required secret keys..."

          # Check RESTIC_REPOSITORY
          if kubectl get secret ${SECRET_NAME} -n {{ include "restic-backup.namespace" . }} -o jsonpath='{.data.RESTIC_REPOSITORY}' | base64 -d > /dev/null 2>&1; then
            echo "✓ RESTIC_REPOSITORY key is present"
          else
            echo "✗ RESTIC_REPOSITORY key is missing"
            exit 1
          fi

          # Check RESTIC_PASSWORD
          if kubectl get secret ${SECRET_NAME} -n {{ include "restic-backup.namespace" . }} -o jsonpath='{.data.RESTIC_PASSWORD}' | base64 -d > /dev/null 2>&1; then
            echo "✓ RESTIC_PASSWORD key is present"
          else
            echo "✗ RESTIC_PASSWORD key is missing"
            exit 1
          fi

          # Test 3: Verify secret values are not empty
          echo "Test 3: Verifying secret values are not empty..."

          REPO_LENGTH=$(kubectl get secret ${SECRET_NAME} -n {{ include "restic-backup.namespace" . }} -o jsonpath='{.data.RESTIC_REPOSITORY}' | base64 -d | wc -c)
          if [ "$REPO_LENGTH" -gt 0 ]; then
            echo "✓ RESTIC_REPOSITORY has a value"
          else
            echo "✗ RESTIC_REPOSITORY is empty"
            exit 1
          fi

          PASS_LENGTH=$(kubectl get secret ${SECRET_NAME} -n {{ include "restic-backup.namespace" . }} -o jsonpath='{.data.RESTIC_PASSWORD}' | base64 -d | wc -c)
          if [ "$PASS_LENGTH" -gt 0 ]; then
            echo "✓ RESTIC_PASSWORD has a value"
          else
            echo "✗ RESTIC_PASSWORD is empty"
            exit 1
          fi

          {{- if .Values.notifications.enabled }}
          {{- if .Values.notifications.email.enabled }}
          # Test 4: Check SMTP password if email notifications enabled
          echo "Test 4: Checking SMTP password for email notifications..."
          if kubectl get secret ${SECRET_NAME} -n {{ include "restic-backup.namespace" . }} -o jsonpath='{.data.SMTP_PASSWORD}' > /dev/null 2>&1; then
            echo "✓ SMTP_PASSWORD key is present"
          else
            echo "⚠ SMTP_PASSWORD key is missing (email notifications may not work)"
          fi
          {{- end }}
          {{- end }}

          echo "All secrets tests passed successfully!"
