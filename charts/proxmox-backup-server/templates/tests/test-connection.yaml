apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "pbs.fullname" . }}-test-connection"
  namespace: {{ include "pbs.namespace" . }}
  labels:
    {{- include "pbs.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
    - name: test-connection
      image: curlimages/curl:latest
      command:
        - /bin/sh
        - -c
        - |
          echo "Testing Proxmox Backup Server connection..."

          # Test 1: HTTPS endpoint responds
          echo "Test 1: Checking HTTPS endpoint..."
          if curl -f -k -s --max-time 10 "https://{{ include "pbs.fullname" . }}:{{ .Values.service.port }}/" > /dev/null; then
            echo "✓ HTTPS endpoint accessible"
          else
            echo "✗ HTTPS endpoint not accessible"
            exit 1
          fi

          # Test 2: Service DNS resolution
          echo "Test 2: Checking DNS resolution..."
          if nslookup "{{ include "pbs.fullname" . }}.{{ include "pbs.namespace" . }}.svc.cluster.local" > /dev/null 2>&1; then
            echo "✓ DNS resolution successful"
          else
            echo "✗ DNS resolution failed"
            exit 1
          fi

          echo "All tests passed!"
  restartPolicy: Never
