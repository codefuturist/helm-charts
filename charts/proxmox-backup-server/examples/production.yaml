# Production deployment example for Proxmox Backup Server
# This configuration includes persistence, monitoring, and best practices

# PBS Configuration
pbs:
  # IMPORTANT: Change these credentials immediately after deployment
  username: "admin@pbs"
  password: "ChangeThisPassword123!"

  # Set your timezone
  timezone: "America/New_York"

  # Enable SMART monitoring for devices (optional)
  smartAccess:
    enabled: false
    # devices:
    #   - /dev/sda
    #   - /dev/sdb

  # Configure backup data volumes
  backupVolumes:
    - name: backups-primary
      mountPath: /backups
      size: 500Gi
      storageClassName: fast-ssd
      accessMode: ReadWriteOnce

# Controller configuration
controller:
  type: deployment
  replicas: 1

  # Graceful shutdown
  terminationGracePeriodSeconds: 60

# Service configuration
service:
  type: ClusterIP
  port: 8007

  # For LoadBalancer:
  # type: LoadBalancer
  # loadBalancerIP: "203.0.113.42"

# Ingress configuration
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
  hosts:
    - host: pbs.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: pbs-tls
      hosts:
        - pbs.example.com

# Persistence - REQUIRED for production
persistence:
  enabled: true

  # Configuration files
  etc:
    enabled: true
    storageClassName: "standard"
    size: 2Gi

  # Log files
  logs:
    enabled: true
    storageClassName: "standard"
    size: 10Gi

  # Library/state files
  lib:
    enabled: true
    storageClassName: "standard"
    size: 20Gi

# Security contexts
podSecurityContext:
  runAsNonRoot: false
  fsGroup: 0
  fsGroupChangePolicy: "OnRootMismatch"
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: true
  runAsNonRoot: false
  runAsUser: 0
  readOnlyRootFilesystem: false
  capabilities:
    drop:
      - ALL
    add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID

# Resources - adjust based on your workload
resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 2Gi

# Health probes
livenessProbe:
  enabled: true
  initialDelaySeconds: 90
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 6

readinessProbe:
  enabled: true
  initialDelaySeconds: 45
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 60

# Monitoring with Prometheus Operator
monitoring:
  serviceMonitor:
    enabled: true
    interval: 60s
    scrapeTimeout: 30s
    labels:
      prometheus: kube-prometheus

  prometheusRule:
    enabled: true
    labels:
      prometheus: kube-prometheus
    rules:
      - alert: ProxmoxBackupServerDown
        expr: up{job="proxmox-backup-server"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Proxmox Backup Server is down"
          description: "PBS instance {{ $labels.instance }} has been down for more than 5 minutes"

      - alert: ProxmoxBackupServerHighMemory
        expr: container_memory_usage_bytes{pod=~".*proxmox-backup-server.*"} > 3500000000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PBS memory usage is high"
          description: "PBS pod {{ $labels.pod }} is using {{ $value | humanize }}B of memory"

# High Availability
pdb:
  enabled: false
  minAvailable: 1

# Pod scheduling
nodeSelector: {}
  # disktype: ssd

tolerations: []
  # - key: "backup-node"
  #   operator: "Equal"
  #   value: "true"
  #   effect: "NoSchedule"

affinity: {}
  # podAntiAffinity:
  #   preferredDuringSchedulingIgnoredDuringExecution:
  #     - weight: 100
  #       podAffinityTerm:
  #         labelSelector:
  #           matchExpressions:
  #             - key: app.kubernetes.io/name
  #               operator: In
  #               values:
  #                 - proxmox-backup-server
  #         topologyKey: kubernetes.io/hostname

# RBAC
serviceAccount:
  create: true
  annotations: {}

rbac:
  create: true

# Network policies
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress

  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8007

  egress:
    # Allow all egress for backup operations
    - to:
        - namespaceSelector: {}
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
