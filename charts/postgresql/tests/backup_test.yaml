suite: test postgresql backup
templates:
  - backup.yaml
  - backup-pvc.yaml
tests:
  - it: should create backup cronjob when enabled
    template: backup.yaml
    set:
      backup.enabled: true
    asserts:
      - isKind:
          of: CronJob
      - equal:
          path: metadata.name
          value: RELEASE-NAME-postgresql-backup
      - equal:
          path: spec.schedule
          value: "0 2 * * *"

  - it: should not create backup when disabled
    template: backup.yaml
    set:
      backup.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create backup PVC when enabled
    template: backup-pvc.yaml
    set:
      backup.enabled: true
      backup.persistence.enabled: true
      backup.persistence.size: "100Gi"
    asserts:
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: spec.resources.requests.storage
          value: "100Gi"

  - it: should configure retention
    template: backup.yaml
    set:
      backup.enabled: true
      backup.retentionDays: 30
    asserts:
      - matchRegex:
          path: spec.jobTemplate.spec.template.spec.containers[0].command[2]
          pattern: "mtime \\+30"
