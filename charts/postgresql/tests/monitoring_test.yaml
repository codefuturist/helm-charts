suite: test postgresql monitoring
templates:
  - servicemonitor.yaml
  - prometheusrule.yaml
tests:
  - it: should create servicemonitor when enabled
    template: servicemonitor.yaml
    set:
      metrics.enabled: true
      monitoring.serviceMonitor.enabled: true
    asserts:
      - isKind:
          of: ServiceMonitor
      - equal:
          path: metadata.name
          value: RELEASE-NAME-postgresql

  - it: should not create servicemonitor when disabled
    template: servicemonitor.yaml
    set:
      metrics.enabled: false
      monitoring.serviceMonitor.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should create prometheusrule when enabled
    template: prometheusrule.yaml
    set:
      metrics.enabled: true
      monitoring.prometheusRule.enabled: true
    asserts:
      - isKind:
          of: PrometheusRule
      - equal:
          path: metadata.name
          value: RELEASE-NAME-postgresql
      - isNotEmpty:
          path: spec.groups

  - it: should include default alert rules
    template: prometheusrule.yaml
    set:
      metrics.enabled: true
      monitoring.prometheusRule.enabled: true
    asserts:
      - contains:
          path: spec.groups[0].rules
          content:
            alert: PostgreSQLDown
          any: true
