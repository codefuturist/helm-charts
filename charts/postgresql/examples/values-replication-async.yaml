# PostgreSQL with Asynchronous Replication
# This configuration provides basic read scaling with async replication

replication:
  enabled: true
  readReplicas: 2
  user: replicator
  password: "changeme-replication-password"

  # Async mode for best performance
  synchronousCommit: "off"

  # Enable replication slots for reliability
  slots:
    enabled: true
    autoCreate: true
    prefix: "replica"

  # Enable read-only service for load balancing reads
  replicaService:
    enabled: true
    type: ClusterIP
    port: 5432
    sessionAffinity: true
    sessionAffinityTimeout: 10800 # 3 hours

  # Replica configuration
  replica:
    hotStandbyFeedback: true
    maxStandbyStreamingDelay: "30s"
    walReceiverStatusInterval: "10s"
    walReceiverTimeout: "60s"

  # Monitoring
  monitoring:
    enabled: true
    scrapeInterval: "30s"
    lagThresholdSeconds: 60
    lagThresholdBytes: 100
    alertFor: "5m"

  # Advanced settings
  advanced:
    maxWalSenders: 10
    maxReplicationSlots: 10
    walKeepSize: "1GB"

# PostgreSQL configuration
postgresql:
  image:
    repository: postgres
    tag: "16.4-alpine"
    pullPolicy: IfNotPresent

  username: postgres
  password: "changeme-postgres-password"
  database: postgres

# Persistence
persistence:
  enabled: true
  size: 10Gi
  accessModes:
    - ReadWriteOnce
  # storageClass: ""  # Use default storage class

# Resources
deployment:
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

# Monitoring
monitoring:
  serviceMonitor:
    enabled: true
    interval: 30s

  prometheusRule:
    enabled: true
# Usage:
# helm install postgres ./postgresql -f examples/values-replication-async.yaml
#
# Access:
# - Write: postgresql.default.svc.cluster.local:5432
# - Read: postgresql-read.default.svc.cluster.local:5432
