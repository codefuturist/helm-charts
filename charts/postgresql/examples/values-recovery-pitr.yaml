# Example: Point-in-Time Recovery (PITR)
# Use this configuration to restore PostgreSQL to a specific point in time

# =====================================================================
# Recovery Configuration
# =====================================================================

recovery:
  # Enable recovery mode
  enabled: true

  # Recovery mode: 'pitr' for point-in-time recovery
  mode: "pitr"

  # Recovery source: 'backup' (PVC) or 's3'
  source: "backup"

  # Optional: Specify exact backup file to use as base
  # If not specified, uses the latest backup before target time
  # backupFile: "backup-2024-11-12-02-00-00.sql.gz"
  backupFile: ""

  # Target time for recovery (REQUIRED for PITR)
  # Format: 'YYYY-MM-DD HH:MM:SS' (UTC)
  # Example scenarios:
  # - Restore to before data deletion: "2024-11-12 14:30:00"
  # - Restore to before failed migration: "2024-11-12 10:00:00"
  # - Restore to before corruption: "2024-11-11 23:59:00"
  targetTime: "2024-11-12 14:30:00"

  # Temporary storage size for recovery process
  # Should be >= your database size
  tempStorageSize: "50Gi"

# =====================================================================
# Basic PostgreSQL Configuration
# =====================================================================

postgresql:
  enabled: true
  database: "postgres"
  username: "postgres"

  config:
    # WAL level must be replica or higher for PITR
    wal_level: "replica"

# =====================================================================
# Persistence
# =====================================================================

persistence:
  enabled: true
  size: 20Gi

# =====================================================================
# Backup Configuration (Required for PITR)
# =====================================================================

backup:
  enabled: true

  persistence:
    enabled: true
    size: 50Gi

  # WAL archiving MUST be enabled for PITR
  wal:
    enabled: true
    method: "simple"
    compression: "gzip"

    persistence:
      enabled: true
      size: 100Gi

# =====================================================================
# Deployment Type
# =====================================================================

deployment:
  type: "statefulset"
  replicaCount: 1
# =====================================================================
# Instructions
# =====================================================================

# PITR Recovery Steps:
#
# 1. Determine target recovery time (YYYY-MM-DD HH:MM:SS UTC)
#    - Check logs for incident time
#    - Use time BEFORE the problem occurred
#
# 2. Update recovery.targetTime above
#
# 3. Install/upgrade with PITR enabled:
#    helm upgrade my-postgres . -f examples/values-recovery-pitr.yaml
#
# 4. Monitor recovery progress:
#    kubectl logs -f job/my-postgres-postgresql-recovery
#
# 5. Verify recovered data:
#    kubectl exec -it my-postgres-0 -- psql -U postgres -c "\dt"
#    kubectl exec -it my-postgres-0 -- psql -U postgres -c "SELECT * FROM your_table LIMIT 10;"
#
# 6. After successful recovery, disable recovery mode:
#    Set recovery.enabled: false
#    helm upgrade my-postgres . -f values.yaml
#
# Common Scenarios:
# - Accidental deletion at 14:31 -> targetTime: "2024-11-12 14:30:00"
# - Failed migration at 10:00 -> targetTime: "2024-11-12 09:59:00"
# - Database corruption detected -> targetTime: "[time of last known good state]"
