# PostgreSQL with Synchronous Replication
# This configuration provides zero data loss guarantees with sync replication

replication:
  enabled: true
  readReplicas: 2
  user: replicator
  password: "changeme-replication-password"

  # Synchronous mode for zero data loss
  # WARNING: Writes will be slower but guaranteed durable
  synchronousCommit: "on" # Can also use "remote_write" or "remote_apply"
  numSynchronousReplicas: 1 # Wait for at least 1 replica to confirm

  # Enable replication slots (critical for sync replication)
  slots:
    enabled: true
    autoCreate: true
    prefix: "replica"

  # Enable read-only service
  replicaService:
    enabled: true
    type: ClusterIP
    port: 5432
    sessionAffinity: true
    sessionAffinityTimeout: 10800

  # Replica configuration
  replica:
    hotStandbyFeedback: true
    maxStandbyStreamingDelay: "30s"
    walReceiverStatusInterval: "5s" # More frequent for sync mode
    walReceiverTimeout: "30s" # Shorter timeout for sync mode

  # Primary configuration
  primary:
    service:
      enabled: true
      type: ClusterIP
      port: 5432

  # Aggressive monitoring for sync replication
  monitoring:
    enabled: true
    scrapeInterval: "15s" # More frequent
    lagThresholdSeconds: 10 # Alert quickly
    lagThresholdBytes: 10 # Alert on small lag
    alertFor: "2m" # Alert faster

  # Advanced settings
  advanced:
    maxWalSenders: 10
    maxReplicationSlots: 10
    walKeepSize: "2GB" # Larger for sync mode

# PostgreSQL configuration
postgresql:
  image:
    repository: postgres
    tag: "16.4-alpine"
    pullPolicy: IfNotPresent

  username: postgres
  password: "changeme-postgres-password"
  database: postgres

  # Performance tuning for sync replication
  config:
    shared_buffers: "512MB"
    effective_cache_size: "1536MB"
    maintenance_work_mem: "128MB"
    checkpoint_completion_target: "0.9"
    wal_buffers: "16MB"
    default_statistics_target: "100"
    random_page_cost: "1.1"
    effective_io_concurrency: "200"
    work_mem: "5242kB"
    min_wal_size: "1GB"
    max_wal_size: "4GB"

# Persistence with better storage class
persistence:
  enabled: true
  size: 20Gi
  accessModes:
    - ReadWriteOnce
  # storageClass: "fast-ssd"  # Use fast SSD storage for sync replication

# Higher resources for sync replication overhead
deployment:
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "2000m"

  # Pod anti-affinity for better availability
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - postgresql
            topologyKey: kubernetes.io/hostname

# Monitoring
monitoring:
  serviceMonitor:
    enabled: true
    interval: 15s

  prometheusRule:
    enabled: true
    additionalLabels:
      severity: critical
# Usage:
# helm install postgres ./postgresql -f examples/values-replication-sync.yaml
#
# Important Notes:
# - Writes will wait for replica confirmation (higher latency)
# - If all replicas are down, writes will BLOCK
# - Use "remote_write" instead of "on" for better performance with minimal data loss risk
# - Monitor replication lag closely - alerts configured aggressively
#
# Access:
# - Write: postgresql.default.svc.cluster.local:5432
# - Read: postgresql-read.default.svc.cluster.local:5432
