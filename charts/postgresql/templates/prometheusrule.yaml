{{- if and .Values.monitoring.prometheusRule.enabled .Values.metrics.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "postgresql.fullname" . }}
  namespace: {{ default (include "postgresql.namespace" .) .Values.monitoring.prometheusRule.namespace }}
  labels:
    {{- include "postgresql.labels" . | nindent 4 }}
    {{- with .Values.monitoring.prometheusRule.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
    - name: postgresql.rules
      interval: 30s
      rules:
        {{- with .Values.monitoring.prometheusRule.rules }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        # Default alert rules
        - alert: PostgreSQLDown
          expr: pg_up == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "PostgreSQL instance is down"
            description: "PostgreSQL instance {{`{{ $labels.instance }}`}} is down for more than 5 minutes"

        - alert: PostgreSQLTooManyConnections
          expr: sum by (instance) (pg_stat_database_numbackends) / pg_settings_max_connections > 0.8
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL has too many connections"
            description: "PostgreSQL instance {{`{{ $labels.instance }}`}} is using {{`{{ $value | humanizePercentage }}`}} of max connections"

        - alert: PostgreSQLDeadLocks
          expr: rate(pg_stat_database_deadlocks[5m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL has deadlocks"
            description: "PostgreSQL instance {{`{{ $labels.instance }}`}} has {{`{{ $value }}`}} deadlocks in the last 5 minutes"

        - alert: PostgreSQLSlowQueries
          expr: pg_stat_activity_max_tx_duration > 300
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL has slow queries"
            description: "PostgreSQL instance {{`{{ $labels.instance }}`}} has queries running for more than 5 minutes"

        - alert: PostgreSQLReplicationLag
          expr: pg_replication_lag > 30
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PostgreSQL replication lag is high"
            description: "PostgreSQL instance {{`{{ $labels.instance }}`}} has replication lag of {{`{{ $value }}`}} seconds"
{{- end }}
