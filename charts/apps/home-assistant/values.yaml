# Default values for home-assistant.
# =============================================================================
# Service Account
# =============================================================================

serviceAccount:
  # -- (bool) Create service account
  create: true
  # -- (object) Annotations for service account
  annotations: {}
  # -- (string) Service account name
  name: ""

# =============================================================================
# RBAC
# =============================================================================

rbac:
  # -- (bool) Create RBAC resources
  create: true

# =============================================================================
# Pod Disruption Budget
# =============================================================================

podDisruptionBudget:
  # -- (bool) Enable PodDisruptionBudget
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# =============================================================================
# Monitoring
# =============================================================================

podAnnotations: {}

# -- (list) Tolerations
tolerations: []

# -- (object) Affinity rules
affinity: {}

# -- (object) Extra volumes
extraVolumes: []

# -- (object) Extra volume mounts
extraVolumeMounts: []

# -- (list) Init containers
initContainers: []

# -- (list) Sidecar containers
extraContainers: []

# =============================================================================
# Configuration Management
# =============================================================================

configuration:
  # -- (bool) Enable automated configuration setup
  # When enabled, creates ConfigMaps and init container to manage HA config files
  enabled: false

  # -- (bool) Force initialization on every start
  # Merges default config with existing config.yaml (keeps 10 most recent backups)
  forceInit: false

  # -- (list) Trusted proxy CIDR ranges for reverse proxy setups
  # Add your ingress controller or load balancer IP ranges
  trusted_proxies:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
    - 127.0.0.0/8

  # -- (string) Template for configuration.yaml file
  # Uses Go templating with access to .Values
  templateConfig: |-
    # Loads default set of integrations. Do not remove.
    default_config:

    {{- if or .Values.ingress.enabled }}
    http:
      use_x_forwarded_for: true
      trusted_proxies:
        {{- range .Values.configuration.trusted_proxies }}
        - {{ . }}
        {{- end }}
    {{- end }}

    # Load frontend themes from the themes folder
    frontend:
      themes: !include_dir_merge_named themes

    automation: !include automations.yaml
    script: !include scripts.yaml
    scene: !include scenes.yaml

  # -- (string) Init script for configuration management
  # Executed before Home Assistant starts
  initScript: |-
    #!/bin/bash
    set -e

    # Create configuration file if it doesn't exist
    if [ ! -f /config/configuration.yaml ]; then
      echo \"Configuration file not found, creating from template\"
      cp /config-templates/configuration.yaml /config/configuration.yaml
    fi

    # Handle forceInit mode
    forceInit=\"{{ .Values.configuration.forceInit }}\"
    if [ \"$forceInit\" = \"true\" ]; then
      echo \"Force init enabled, merging configuration\"
      current_time=$(date +%Y%m%d_%H%M%S)
      echo \"Backing up current config to configuration.yaml.$current_time\"
      cp /config/configuration.yaml /config/configuration.yaml.$current_time

      echo \"Cleaning up old backups (keeping 10 most recent)\"
      ls -t /config/configuration.yaml.* 2>/dev/null | tail -n +11 | xargs -r rm

      if [[ ! -s /config/configuration.yaml ]]; then
        cat /config-templates/configuration.yaml > /config/configuration.yaml
      else
        yq eval-all --inplace 'select(fileIndex == 0) *d select(fileIndex == 1)' /config/configuration.yaml /config-templates/configuration.yaml
      fi
    fi

    # Create required YAML files if missing
    for file in automations.yaml scripts.yaml scenes.yaml; do
      if [ ! -f /config/$file ]; then
        echo \"Creating $file\"
        echo \"[]\" > /config/$file
      fi
    done

  # -- (object) Init container configuration
  initContainer:
    # -- (string) Init container name
    name: setup-config
    # -- (string) Init container image (needs yq tool)
    image: mikefarah/yq:4
    # -- (object) Init container security context
    securityContext:
      runAsUser: 0
    # -- (list) Additional volume mounts for init container
    volumeMounts: []
