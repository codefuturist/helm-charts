suite: test container configuration environment variables
templates:
  - deployment.yaml
  - statefulset.yaml
  - configmap.yaml
  - secret.yaml
tests:
  # Test SCRIPT_NAME environment variable
  - it: should set SCRIPT_NAME when scriptName is provided (deployment)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        scriptName: "/pgadmin4"
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SCRIPT_NAME
            value: "/pgadmin4"

  - it: should set SCRIPT_NAME when scriptName is provided (statefulset)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        scriptName: "/admin"
      controller:
        type: statefulset
    asserts:
      - template: statefulset.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SCRIPT_NAME
            value: "/admin"

  - it: should not set SCRIPT_NAME when scriptName is empty
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        scriptName: ""
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: SCRIPT_NAME

  # Test PGADMIN_DISABLE_POSTFIX environment variable
  - it: should set PGADMIN_DISABLE_POSTFIX when disablePostfix is true (deployment)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        disablePostfix: true
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_DISABLE_POSTFIX
            value: "1"

  - it: should set PGADMIN_DISABLE_POSTFIX when disablePostfix is true (statefulset)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        disablePostfix: true
      controller:
        type: statefulset
    asserts:
      - template: statefulset.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_DISABLE_POSTFIX
            value: "1"

  - it: should not set PGADMIN_DISABLE_POSTFIX when disablePostfix is false
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        disablePostfix: false
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_DISABLE_POSTFIX

  # Test PGADMIN_REPLACE_SERVERS_ON_STARTUP environment variable
  - it: should set PGADMIN_REPLACE_SERVERS_ON_STARTUP when replaceServersOnStartup is true (deployment)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        replaceServersOnStartup: true
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_REPLACE_SERVERS_ON_STARTUP
            value: "True"

  - it: should set PGADMIN_REPLACE_SERVERS_ON_STARTUP when replaceServersOnStartup is true (statefulset)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        replaceServersOnStartup: true
      controller:
        type: statefulset
    asserts:
      - template: statefulset.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_REPLACE_SERVERS_ON_STARTUP
            value: "True"

  - it: should not set PGADMIN_REPLACE_SERVERS_ON_STARTUP when replaceServersOnStartup is false
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        replaceServersOnStartup: false
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_REPLACE_SERVERS_ON_STARTUP

  # Test PGADMIN_SERVER_JSON_FILE environment variable
  - it: should set PGADMIN_SERVER_JSON_FILE when serverDefinitions is provided (deployment)
    set:
      pgadmin.email: test@example.com
      pgadmin.password: TestPassword123
      pgadmin.serverDefinitions.servers.1.Name: "Test"
      pgadmin.serverDefinitions.servers.1.Host: "localhost"
      pgadmin.serverDefinitions.servers.1.Port: 5432
      controller.type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_SERVER_JSON_FILE
            value: "/pgadmin4/servers.json"

  - it: should set PGADMIN_SERVER_JSON_FILE when existingServerDefinitionsConfigMap is provided (statefulset)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        existingServerDefinitionsConfigMap: my-servers
      controller:
        type: statefulset
    asserts:
      - template: statefulset.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGADMIN_SERVER_JSON_FILE
            value: "/pgadmin4/servers.json"

  # Test PGPASS_FILE environment variable
  - it: should set PGPASS_FILE when pgpassFile is provided (deployment)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        pgpassFile: "localhost:5432:*:user:pass"
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGPASS_FILE
            value: "/var/lib/pgadmin/.pgpass"

  - it: should set PGPASS_FILE when existingPgpassSecret is provided (statefulset)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        existingPgpassSecret: my-pgpass-secret
      controller:
        type: statefulset
    asserts:
      - template: statefulset.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PGPASS_FILE
            value: "/var/lib/pgadmin/.pgpass"

  # Test Gunicorn environment variables
  - it: should set GUNICORN_THREADS (deployment)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        gunicorn:
          threads: 50
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GUNICORN_THREADS
            value: "50"

  - it: should set GUNICORN_ACCESS_LOGFILE when provided (deployment)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        gunicorn:
          accessLogfile: "/var/log/access.log"
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GUNICORN_ACCESS_LOGFILE
            value: "/var/log/access.log"

  - it: should not set GUNICORN_ACCESS_LOGFILE when empty
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        gunicorn:
          accessLogfile: ""
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: GUNICORN_ACCESS_LOGFILE

  - it: should set GUNICORN_LIMIT_REQUEST_LINE (statefulset)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
        gunicorn:
          limitRequestLine: 16380
      controller:
        type: statefulset
    asserts:
      - template: statefulset.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GUNICORN_LIMIT_REQUEST_LINE
            value: "16380"

  - it: should use default Gunicorn values when not overridden (deployment)
    set:
      pgadmin:
        email: test@example.com
        password: TestPassword123
      controller:
        type: deployment
    asserts:
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GUNICORN_THREADS
            value: "25"
      - template: deployment.yaml
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: GUNICORN_LIMIT_REQUEST_LINE
            value: "8190"
