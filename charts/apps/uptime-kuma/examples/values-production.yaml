# Production pgAdmin Configuration
#
# This configuration follows best practices for production deployments:
# - Uses existing secrets for credentials
# - Enables persistence
# - Configures resource limits
# - Enables monitoring and network policies
# - Includes pre-configured PostgreSQL servers
#
# Prerequisites:
#   kubectl create secret generic pgadmin-credentials \
#     --from-literal=email=admin@example.com \
#     --from-literal=password=YourSecurePassword123
#
# Usage:
#   helm install my-pgadmin codefuturist/pgadmin -f values-production.yaml

# =============================================================================
# Security: Use existing secret instead of inline credentials
# =============================================================================
pgadmin:
  existingSecret: "pgadmin-credentials"

  # Pre-configured PostgreSQL server connections
  serverDefinitions:
    servers:
      1:
        Name: "Production PostgreSQL"
        Group: "Production"
        Host: "postgresql.database.svc.cluster.local"
        Port: 5432
        MaintenanceDB: "postgres"
        Username: "postgres"
        SSLMode: "prefer"
        Comment: "Production database cluster"
      2:
        Name: "Staging PostgreSQL"
        Group: "Staging"
        Host: "postgresql-staging.database.svc.cluster.local"
        Port: 5432
        MaintenanceDB: "postgres"
        Username: "postgres"
        SSLMode: "prefer"
        Comment: "Staging database cluster"

  # Use existing secret for pgpass file
  existingPgpassSecret: "pgadmin-pgpass"

  # SMTP configuration for email alerts
  smtp:
    enabled: true
    server: "smtp.example.com"
    port: 587
    useSSL: false
    useTLS: true
    username: "pgadmin@example.com"
    existingSecret: "pgadmin-smtp"

# =============================================================================
# Controller: Deployment with lifecycle hooks
# =============================================================================
controller:
  type: deployment
  terminationGracePeriodSeconds: 60

# =============================================================================
# Persistence: Enable for production to retain configurations
# =============================================================================
persistence:
  enabled: true
  size: 5Gi
  storageClassName: "" # Use default storage class
  accessMode: ReadWriteOnce

# =============================================================================
# Resources: Production-appropriate resource allocation
# =============================================================================
resources:
  limits:
    cpu: 2000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# =============================================================================
# High Availability: Pod disruption budget and horizontal autoscaling
# =============================================================================
pdb:
  enabled: true
  minAvailable: 1

hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPU: 80
  targetMemory: 80

# =============================================================================
# Ingress: Expose pgAdmin securely
# =============================================================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: pgadmin.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: pgadmin-tls
      hosts:
        - pgadmin.example.com

# =============================================================================
# Monitoring: Enable Prometheus ServiceMonitor and alerting rules
# =============================================================================
monitoring:
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    labels:
      prometheus: kube-prometheus
    metricRelabelings:
      - sourceLabels: [__name__]
        regex: "go_.*"
        action: drop

  prometheusRule:
    enabled: true
    rules:
      - alert: PgAdminDown
        expr: up{job="pgadmin"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "pgAdmin is down"
          description: "pgAdmin has been down for more than 5 minutes"
      - alert: PgAdminHighMemory
        expr: container_memory_usage_bytes{container="pgadmin"} > 900000000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "pgAdmin high memory usage"
          description: "pgAdmin memory usage is above 900MB"

# =============================================================================
# Network Policy: Restrict network access
# =============================================================================
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress

  # Allow ingress from nginx ingress controller
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80

  # Allow egress to PostgreSQL and DNS
  egress:
    # PostgreSQL databases
    - to:
        - namespaceSelector:
            matchLabels:
              name: database
      ports:
        - protocol: TCP
          port: 5432
    # DNS resolution
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
    # HTTPS for potential extensions/updates
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

# =============================================================================
# Security Context: Enhanced security
# =============================================================================
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 5050
  fsGroup: 5050
  fsGroupChangePolicy: "OnRootMismatch"
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  runAsUser: 5050
  readOnlyRootFilesystem: false
  capabilities:
    drop:
      - ALL

# =============================================================================
# Pod Configuration: Production scheduling
# =============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - pgadmin
          topologyKey: kubernetes.io/hostname

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: pgadmin

priorityClassName: "high-priority"

# Extra environment variables for advanced configuration
extraEnv:
  - name: PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION
    value: "True"
  - name: PGADMIN_CONFIG_SESSION_COOKIE_HTTPONLY
    value: "True"
  - name: PGADMIN_CONFIG_SESSION_COOKIE_SECURE
    value: "True"
  - name: PGADMIN_CONFIG_SESSION_COOKIE_SAMESITE
    value: "Lax"

# =============================================================================
# Additional Configuration
# =============================================================================
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "80"

additionalLabels:
  environment: production
  team: database-ops
