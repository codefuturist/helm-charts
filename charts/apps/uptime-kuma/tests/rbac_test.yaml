suite: test uptime-kuma RBAC
templates:
  - serviceaccount.yaml
  - rbac.yaml
tests:
  - it: should create ServiceAccount by default
    template: serviceaccount.yaml
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-uptime-kuma

  - it: should not create ServiceAccount when disabled
    template: serviceaccount.yaml
    set:
      serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom ServiceAccount name
    template: serviceaccount.yaml
    set:
      serviceAccount.name: "custom-sa"
    asserts:
      - equal:
          path: metadata.name
          value: "custom-sa"

  - it: should add ServiceAccount annotations
    template: serviceaccount.yaml
    set:
      serviceAccount.annotations:
        eks.amazonaws.com/role-arn: "arn:aws:iam::123456789:role/my-role"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789:role/my-role"

  - it: should create RBAC resources by default
    template: rbac.yaml
    asserts:
      - hasDocuments:
          count: 2

  - it: should not create RBAC when disabled
    template: rbac.yaml
    set:
      rbac.create: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create Role and RoleBinding
    template: rbac.yaml
    asserts:
      - isKind:
          of: Role
        documentIndex: 0
      - isKind:
          of: RoleBinding
        documentIndex: 1
