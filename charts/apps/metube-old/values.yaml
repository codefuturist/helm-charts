# =============================================================================
# Global Parameters
# @section -- Global Parameters
# =============================================================================

# -- Override the namespace for all resources
# @default -- `.Release.Namespace`
namespaceOverride: ""

# -- Override the name of the chart
nameOverride: ""

# -- Override the full name of the chart
fullnameOverride: ""

# -- Additional labels to add to all resources
additionalLabels: {}

# -- Additional annotations to add to all resources
additionalAnnotations: {}

# =============================================================================
# Image Configuration
# @section -- Image Configuration
# =============================================================================

image:
  # -- MeTube Docker image repository
  repository: ghcr.io/alexta69/metube
  # -- MeTube Docker image tag
  # @default -- Chart appVersion
  tag: ""
  # -- Image pull policy
  pullPolicy: IfNotPresent
  # -- Image digest (overrides tag if set)
  digest: ""

# -- Image pull secrets for private registries
imagePullSecrets: []

# =============================================================================
# MeTube Configuration
# @section -- MeTube Configuration
# =============================================================================

metube:
  # -- Download behavior mode (sequential, concurrent, limited)
  # sequential: One download at a time
  # concurrent: Unlimited simultaneous downloads
  # limited: Controlled concurrency (see maxConcurrentDownloads)
  downloadMode: "limited"

  # -- Maximum concurrent downloads (only used with downloadMode: limited)
  maxConcurrentDownloads: 3

  # -- Delete files from server when trashed in UI
  deleteFileOnTrashcan: false

  # -- Enable strict playlist mode by default
  # In strict mode, playlists download only if URL strictly points to playlist
  defaultOptionPlaylistStrictMode: false

  # -- Maximum playlist items to download (0 = no limit)
  defaultOptionPlaylistItemLimit: 0

  # -- Enable custom directories for organizing downloads
  customDirs: true

  # -- Allow creating new custom directories on the fly
  createCustomDirs: true

  # -- Regular expression to exclude directories from dropdown
  # Default excludes hidden directories and those starting with @
  customDirsExcludeRegex: "(^|/)[.@].*$"

  # -- Make download directories indexable on web server
  downloadDirsIndexable: false

  # -- Output filename template for yt-dlp
  # See: https://github.com/yt-dlp/yt-dlp#output-template
  outputTemplate: "%(title)s.%(ext)s"

  # -- Output filename template for chapters
  outputTemplateChapter: "%(title)s - %(section_number)s %(section_title)s.%(ext)s"

  # -- Output filename template for playlists (empty uses outputTemplate)
  outputTemplatePlaylist: "%(playlist_title)s/%(title)s.%(ext)s"

  # -- Additional yt-dlp options in JSON format
  # See: https://github.com/yt-dlp/yt-dlp#usage-and-options
  # Example: '{"format": "bestvideo+bestaudio", "writesubtitles": true}'
  ytdlOptions: ""

  # -- Path to JSON file with yt-dlp options (mounted via ConfigMap)
  # Takes precedence over ytdlOptions if both are set
  ytdlOptionsFile: ""

  # -- Name of existing ConfigMap containing ytdl_options.json
  existingYtdlOptionsConfigMap: ""

  # -- URL prefix for reverse proxy subdirectory hosting
  # Example: /metube for hosting at https://example.com/metube
  urlPrefix: "/"

  # -- Base URL for download links in the UI
  # Leave empty to serve files through MeTube itself
  publicHostUrl: ""

  # -- Base URL for audio download links
  publicHostAudioUrl: ""

  # -- Enable HTTPS mode (requires certFile and keyFile)
  https: false

  # -- Path to SSL certificate file (mounted via secret)
  certFile: ""

  # -- Path to SSL key file (mounted via secret)
  keyFile: ""

  # -- Name of existing secret containing SSL certificate and key
  # Secret must contain keys: tls.crt and tls.key
  existingTlsSecret: ""

  # -- Path to robots.txt file (mounted via ConfigMap)
  robotsTxt: ""

  # -- Name of existing ConfigMap containing robots.txt
  existingRobotsTxtConfigMap: ""

  # -- User ID to run MeTube as
  uid: 1000

  # -- Group ID to run MeTube as
  gid: 1000

  # -- Umask for created files and directories
  umask: "022"

  # -- Default UI theme (light, dark, auto)
  defaultTheme: "auto"

  # -- Log level (DEBUG, INFO, WARNING, ERROR, CRITICAL, NONE)
  loglevel: "INFO"

  # -- Enable access log
  enableAccesslog: false

  # -- Cookie file support for authenticated downloads
  cookies:
    # -- Enable cookie file support
    enabled: false
    # -- Cookie file content (cookies.txt format)
    # Format: Netscape cookie file
    cookieFile: ""
    # -- Name of existing secret containing cookies.txt
    # Secret must contain key: cookies.txt
    existingSecret: ""

# =============================================================================
# Storage Paths
# @section -- Storage Configuration
# =============================================================================

storage:
  # -- Main download directory path inside container
  downloadDir: "/downloads"

  # -- Audio-only download directory (empty = same as downloadDir)
  audioDownloadDir: ""

  # -- State directory for queue persistence
  # @default -- /downloads/.metube
  stateDir: ""

  # -- Temporary directory for intermediate files
  # Consider using tmpfs for better performance
  tempDir: ""

# =============================================================================
# Controller Configuration
# @section -- Controller Configuration
# =============================================================================

controller:
  # -- Controller type (deployment or statefulset)
  type: deployment

  # -- Number of MeTube replicas
  # Note: Multiple replicas share the same storage, ensure your storage supports ReadWriteMany if scaling
  replicas: 1

  # -- Deployment update strategy
  strategy:
    type: Recreate

  # -- StatefulSet update strategy (only used if controller.type is statefulset)
  updateStrategy:
    type: RollingUpdate

  # -- Pod management policy (only used if controller.type is statefulset)
  podManagementPolicy: OrderedReady

  # -- Command override for the main container
  command: []

  # -- Args override for the main container
  args: []

  # -- Working directory for the main container
  workingDir: ""

  # -- Termination grace period in seconds
  terminationGracePeriodSeconds: 30

  # -- Lifecycle hooks for the main container
  lifecycle: {}
    # preStop:
    #   exec:
    #     command:
    #       - /bin/sh
    #       - -c
    #       - sleep 15

# =============================================================================
# Service Configuration
# @section -- Service Configuration
# =============================================================================

service:
  # -- Service type
  type: ClusterIP

  # -- Service port
  port: 8081

  # -- Service target port (container port)
  targetPort: 8081

  # -- Node port (only used if type is NodePort)
  nodePort: ""

  # -- Load balancer IP (only used if type is LoadBalancer)
  loadBalancerIP: ""

  # -- Load balancer source ranges (only used if type is LoadBalancer)
  loadBalancerSourceRanges: []

  # -- External traffic policy (only used if type is LoadBalancer or NodePort)
  externalTrafficPolicy: ""

  # -- Cluster IP (set to None for headless service)
  clusterIP: ""

  # -- Session affinity
  sessionAffinity: None

  # -- Session affinity config
  sessionAffinityConfig: {}

  # -- Service annotations
  annotations: {}

  # -- Service labels
  labels: {}

# =============================================================================
# Ingress Configuration
# @section -- Ingress Configuration
# =============================================================================

ingress:
  # -- Enable ingress
  enabled: false

  # -- Ingress class name
  className: ""

  # -- Ingress annotations
  # Example for nginx ingress:
  # annotations:
  #   cert-manager.io/cluster-issuer: "letsencrypt-prod"
  #   nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
  #   nginx.ingress.kubernetes.io/proxy-body-size: "0"
  annotations: {}

  # -- Ingress hosts configuration
  # Example:
  # hosts:
  #   - host: metube.example.com
  #     paths:
  #       - path: /
  #         pathType: Prefix
  hosts: []

  # -- Ingress TLS configuration
  # Example:
  # tls:
  #   - secretName: metube-tls
  #     hosts:
  #       - metube.example.com
  tls: []

# =============================================================================
# Persistence Configuration
# @section -- Persistence Configuration
# =============================================================================

persistence:
  # -- Enable persistent storage for downloads
  enabled: true

  # -- Storage class name
  # @default -- Default storage class
  storageClassName: ""

  # -- Access mode for the persistent volume
  # Use ReadWriteMany if running multiple replicas
  accessMode: ReadWriteOnce

  # -- Size of the persistent volume for downloads
  # Recommended: 50Gi-100Gi for typical usage
  size: 10Gi

  # -- Name of an existing PVC to use
  existingClaim: ""

  # -- Annotations for the PVC
  annotations: {}

  # -- Additional volumes for specific use cases
  additionalVolumes: []
    # - name: audio-downloads
    #   enabled: false
    #   mountPath: /audio
    #   size: 10Gi
    #   storageClassName: ""
    #   accessMode: ReadWriteOnce

# =============================================================================
# Security Context
# @section -- Security Context
# =============================================================================

# -- Pod security context
podSecurityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true

# -- Container security context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  capabilities:
    drop:
      - ALL

# =============================================================================
# Resources
# @section -- Resources
# =============================================================================

# -- Resource limits and requests
# Downloads can be CPU intensive during transcoding
# Minimal requests to allow scheduling, no limits to allow bursting
resources:
  limits: {}
  requests:
    cpu: 10m
    memory: 64Mi

# =============================================================================
# Probes
# @section -- Health Probes
# =============================================================================

# -- Liveness probe configuration
livenessProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

# -- Readiness probe configuration
readinessProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 15
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3
  successThreshold: 1

# -- Startup probe configuration
startupProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 30
  successThreshold: 1

# =============================================================================
# Pod Configuration
# @section -- Pod Configuration
# =============================================================================

# -- Pod annotations
podAnnotations: {}

# -- Pod labels
podLabels: {}

# -- Node selector for pod assignment
nodeSelector: {}

# -- Tolerations for pod assignment
tolerations: []

# -- Affinity for pod assignment
affinity: {}

# -- Priority class name for the pod
priorityClassName: ""

# -- Topology spread constraints for pod distribution
topologySpreadConstraints: []
  # - maxSkew: 1
  #   topologyKey: topology.kubernetes.io/zone
  #   whenUnsatisfiable: ScheduleAnyway
  #   labelSelector:
  #     matchLabels:
  #       app.kubernetes.io/name: metube

# -- DNS policy
dnsPolicy: ClusterFirst

# -- DNS config
dnsConfig: {}
  # nameservers:
  #   - 1.1.1.1
  # searches:
  #   - default.svc.cluster.local
  # options:
  #   - name: ndots
  #     value: "2"

# -- Host aliases
hostAliases: []
  # - ip: "192.168.1.100"
  #   hostnames:
  #     - "video-source.local"

# -- Runtime class name
runtimeClassName: ""

# -- Init containers to run before the main container
initContainers: []
  # - name: init-permissions
  #   image: busybox:latest
  #   command: ['sh', '-c', 'chown -R 1000:1000 /downloads']
  #   volumeMounts:
  #     - name: downloads
  #       mountPath: /downloads

# -- Extra sidecar containers
extraContainers: []
  # - name: exporter
  #   image: metrics-exporter:latest
  #   ports:
  #     - containerPort: 9090

# -- Extra environment variables
extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "custom-value"

# -- Extra environment variables from ConfigMaps or Secrets
extraEnvFrom: []
  # - configMapRef:
  #     name: metube-config
  # - secretRef:
  #     name: metube-secrets

# -- Extra volumes
extraVolumes: []
  # - name: ytdl-config
  #   configMap:
  #     name: ytdl-custom-config
  # - name: ssl-certs
  #   secret:
  #     secretName: metube-tls

# -- Extra volume mounts
extraVolumeMounts: []
  # - name: ytdl-config
  #   mountPath: /config
  #   readOnly: true

# =============================================================================
# Monitoring
# @section -- Monitoring
# =============================================================================

monitoring:
  serviceMonitor:
    # -- Enable ServiceMonitor for Prometheus Operator
    enabled: false

    # -- Namespace for the ServiceMonitor (defaults to the release namespace)
    namespace: ""

    # -- Interval at which metrics should be scraped
    interval: 30s

    # -- Timeout for scraping metrics
    scrapeTimeout: 10s

    # -- Additional labels for the ServiceMonitor
    labels: {}

    # -- Additional annotations for the ServiceMonitor
    annotations: {}

    # -- Metric relabelings
    metricRelabelings: []

    # -- Relabelings
    relabelings: []

  prometheusRule:
    # -- Enable PrometheusRule for alerting
    enabled: false

    # -- Namespace for the PrometheusRule (defaults to the release namespace)
    namespace: ""

    # -- Additional labels for the PrometheusRule
    labels: {}

    # -- Alert rules
    rules: []
      # - alert: MeTubeDown
      #   expr: up{job="metube"} == 0
      #   for: 5m
      #   labels:
      #     severity: critical
      #   annotations:
      #     summary: "MeTube is down"
      #     description: "MeTube instance {{ $labels.instance }} is down"
      # - alert: MeTubeHighMemory
      #   expr: container_memory_usage_bytes{pod=~"metube-.*"} / container_spec_memory_limit_bytes > 0.9
      #   for: 10m
      #   labels:
      #     severity: warning
      #   annotations:
      #     summary: "MeTube high memory usage"
      #     description: "MeTube memory usage is above 90%"

# =============================================================================
# High Availability
# @section -- High Availability
# =============================================================================

pdb:
  # -- Enable PodDisruptionBudget
  enabled: false

  # -- Minimum number of pods that must be available
  minAvailable: 1

  # -- Maximum number of pods that can be unavailable
  maxUnavailable: ""

# -- Horizontal Pod Autoscaler configuration
# Note: HPA may not be ideal for MeTube as downloads benefit from consistent resources
hpa:
  # -- Enable HorizontalPodAutoscaler
  enabled: false

  # -- Minimum number of replicas
  minReplicas: 1

  # -- Maximum number of replicas
  maxReplicas: 3

  # -- Target CPU utilization percentage
  targetCPUUtilizationPercentage: 80

  # -- Target memory utilization percentage
  targetMemoryUtilizationPercentage: 80

  # -- Custom metrics for autoscaling
  customMetrics: []

# =============================================================================
# RBAC Configuration
# @section -- RBAC Configuration
# =============================================================================

serviceAccount:
  # -- Create a service account
  create: true

  # -- Service account name (generated if not set and create is true)
  name: ""

  # -- Service account annotations
  annotations: {}

rbac:
  # -- Create RBAC resources
  create: true

  # -- Additional RBAC rules
  rules: []

# =============================================================================
# Network Policy
# @section -- Network Policy
# =============================================================================

networkPolicy:
  # -- Enable network policy
  enabled: false

  # -- Policy types
  policyTypes:
    - Ingress
    - Egress

  # -- Ingress rules
  # Example to allow traffic from ingress controller:
  # ingress:
  #   - from:
  #     - namespaceSelector:
  #         matchLabels:
  #           name: ingress-nginx
  #     ports:
  #     - protocol: TCP
  #       port: 8081
  ingress: []

  # -- Egress rules
  # MeTube needs internet access to download videos
  egress:
    # Allow all outbound traffic (for video downloads)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53

# =============================================================================
# Diagnostic Mode
# @section -- Diagnostic Mode
# =============================================================================

diagnosticMode:
  # -- Enable diagnostic mode (disables probes, overrides command)
  # Useful for debugging container startup issues
  enabled: false

  # -- Command override for diagnostic mode
  command:
    - sleep

  # -- Args override for diagnostic mode
  args:
    - infinity
