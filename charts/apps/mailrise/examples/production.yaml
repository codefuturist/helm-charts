# Production deployment example for Mailrise
# Includes TLS, authentication, monitoring, and high availability

mailrise:
  config:
    configs:
      # Critical alerts - multiple notification services
      critical:
        urls:
          - "tgram://BOT_TOKEN/CHAT_ID"
          - "discord://WEBHOOK_ID/WEBHOOK_TOKEN"
          - "pover://USER_KEY@TOKEN"
        mailrise:
          title_template: "ðŸš¨ CRITICAL: $subject"
          body_template: "$body\n\nFrom: $from"
          body_format: "text"

      # Standard notifications
      notifications:
        urls:
          - "discord://WEBHOOK_ID/WEBHOOK_TOKEN"

      # Catch-all for any other emails
      "*@*":
        urls:
          - "json://localhost/fallback"

    listen:
      host: "0.0.0.0"
      port: 8025

    tls:
      mode: "starttls"

    smtp:
      auth:
        basic:
          mailuser: "SecurePassword123!"

  tls:
    enabled: true
    existingSecret: "mailrise-tls-cert"

  auth:
    enabled: true
    users:
      mailuser: "SecurePassword123!"

controller:
  type: deployment
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

service:
  type: LoadBalancer
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"

resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

pdb:
  enabled: true
  minAvailable: 2

hpa:
  enabled: false

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: mailrise
          topologyKey: kubernetes.io/hostname

monitoring:
  serviceMonitor:
    enabled: true
    interval: 60s
    labels:
      prometheus: kube-prometheus

  prometheusRule:
    enabled: true
    labels:
      prometheus: kube-prometheus
    rules:
      - alert: MailriseDown
        expr: up{job="mailrise"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Mailrise is down"
          description: "Mailrise instance {{ $labels.instance }} has been down for more than 5 minutes"

networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8025
  egress:
    # Allow all egress for Apprise notifications
    - {}
