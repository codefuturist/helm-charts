suite: test pbs secrets
templates:
  - secret.yaml
tests:
  - it: should create secret with inline credentials
    set:
      pbs.email: admin@example.com
      pbs.password: test123
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-pbs
      - equal:
          path: type
          value: Opaque
      - isNotEmpty:
          path: data.email
      - isNotEmpty:
          path: data.password

  - it: should not create secret when using existing secret
    set:
      pbs.existingSecret: "my-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create SMTP secret when enabled
    set:
      pbs.email: admin@example.com
      pbs.password: test123
      pbs.smtp.enabled: true
      pbs.smtp.username: smtp@example.com
      pbs.smtp.password: smtppass123
    asserts:
      - hasDocuments:
          count: 2

  - it: should create pgpass secret when enabled
    set:
      pbs.email: admin@example.com
      pbs.password: test123
      pbs.pgpassFile.enabled: true
      pbs.pgpassFile.existingSecret: ""
      pbs.pgpassFile.content: "localhost:5432:*:postgres:password"
    asserts:
      - hasDocuments:
          count: 2
