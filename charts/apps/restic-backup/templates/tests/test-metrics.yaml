apiVersion: v1
kind: Pod
metadata:
  name: {{ include "restic-backup.name" . }}-test-metrics
  namespace: {{ include "restic-backup.namespace" . }}
  labels:
    {{- include "restic-backup.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  restartPolicy: Never
  containers:
    - name: test-metrics
      image: curlimages/curl:latest
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing metrics endpoint availability..."

          {{- if .Values.metrics.enabled }}
          # Test 1: Check if metrics service exists
          echo "Test 1: Checking metrics service..."
          SERVICE_NAME="{{ include "restic-backup.name" . }}-metrics"
          SERVICE_PORT="{{ .Values.metrics.service.port }}"

          # Wait for service to be ready (max 30 seconds)
          for i in $(seq 1 30); do
            if nslookup ${SERVICE_NAME} > /dev/null 2>&1; then
              echo "✓ Metrics service is reachable via DNS"
              break
            fi
            echo "Waiting for metrics service... ($i/30)"
            sleep 1
          done

          # Test 2: Check if metrics endpoint responds
          echo "Test 2: Checking metrics endpoint..."
          if curl -sf http://${SERVICE_NAME}:${SERVICE_PORT}/metrics > /dev/null; then
            echo "✓ Metrics endpoint is responding"
          else
            echo "✗ Metrics endpoint is not responding"
            exit 1
          fi

          # Test 3: Verify metrics format
          echo "Test 3: Verifying Prometheus metrics format..."
          METRICS=$(curl -s http://${SERVICE_NAME}:${SERVICE_PORT}/metrics)

          if echo "$METRICS" | grep -q "^# HELP"; then
            echo "✓ Metrics contain HELP comments"
          else
            echo "✗ Metrics missing HELP comments"
            exit 1
          fi

          if echo "$METRICS" | grep -q "^# TYPE"; then
            echo "✓ Metrics contain TYPE definitions"
          else
            echo "✗ Metrics missing TYPE definitions"
            exit 1
          fi

          # Test 4: Check for expected metrics
          echo "Test 4: Checking for expected metrics..."
          EXPECTED_METRICS="restic_exporter_up restic_repository_size_bytes restic_snapshots_total"

          for metric in $EXPECTED_METRICS; do
            if echo "$METRICS" | grep -q "^$metric"; then
              echo "✓ Metric '$metric' is present"
            else
              echo "⚠ Metric '$metric' is missing (may be unavailable initially)"
            fi
          done

          # Test 5: Health endpoint
          echo "Test 5: Checking health endpoint..."
          if curl -sf http://${SERVICE_NAME}:${SERVICE_PORT}/health > /dev/null; then
            echo "✓ Health endpoint is responding"
          else
            echo "✗ Health endpoint is not responding"
            exit 1
          fi

          echo "All metrics tests passed successfully!"
          {{- else }}
          echo "Metrics not enabled, skipping metrics tests"
          {{- end }}
