apiVersion: v1
kind: Pod
metadata:
  name: {{ include "restic-backup.name" . }}-test
  namespace: {{ include "restic-backup.namespace" . }}
  labels:
    {{- include "restic-backup.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  restartPolicy: Never
  serviceAccountName: {{ include "restic-backup.serviceAccountName" . }}
  containers:
    - name: test
      image: {{ include "restic-backup.image" . }}
      command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Testing restic backup chart installation..."

          # Test 1: Check if restic is available
          echo "Test 1: Checking restic binary..."
          restic version

          # Test 2: Check if repository is accessible
          echo "Test 2: Checking repository access..."
          if restic snapshots --quiet > /dev/null 2>&1; then
            echo "✓ Repository is accessible and initialized"
          else
            echo "✗ Repository is not accessible or not initialized"
            exit 1
          fi

          # Test 3: List snapshots
          echo "Test 3: Listing snapshots..."
          restic snapshots || echo "No snapshots yet (this is ok for new installations)"

          # Test 4: Check repository stats
          echo "Test 4: Checking repository stats..."
          restic stats || echo "No stats yet (this is ok for new installations)"

          echo "All tests passed successfully!"
      env:
        - name: RESTIC_REPOSITORY
          valueFrom:
            secretKeyRef:
              name: {{ include "restic-backup.secretName" . }}
              key: RESTIC_REPOSITORY
        - name: RESTIC_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "restic-backup.secretName" . }}
              key: RESTIC_PASSWORD
      envFrom:
        - secretRef:
            name: {{ include "restic-backup.secretName" . }}
