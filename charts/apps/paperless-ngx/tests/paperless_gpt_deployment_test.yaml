suite: paperless-gpt-deployment
templates:
  - paperless-gpt-env-secret.yaml
  - paperless-gpt-deployment.yaml
tests:
  - it: renders Paperless-GPT deployment with managed env secret
    set:
      paperlessGpt.enabled: true
    asserts:
      - documentIndex: 1
        isKind:
          of: Deployment
      - documentIndex: 1
        equal:
          path: metadata.name
          value: RELEASE-NAME-paperless-ngx-paperless-gpt
      - documentIndex: 1
        contains:
          path: spec.template.spec.containers[0].env
          content:
            name: PAPERLESS_API_URL
            value: http://RELEASE-NAME-paperless-ngx:80/api
      - documentIndex: 1
        contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: paperless-gpt-env
            mountPath: /app/data/.env
            subPath: paperless-gpt.env
            readOnly: true
      - documentIndex: 1
        contains:
          path: spec.template.spec.volumes
          content:
            name: paperless-gpt-env
            secret:
              secretName: RELEASE-NAME-paperless-ngx-paperless-gpt-env

  - it: adds envFrom references for provided secrets
    set:
      paperlessGpt.enabled: true
      paperlessGpt.envFromSecrets:
        - shared-creds
        - other-secret
    asserts:
      - documentIndex: 1
        contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: shared-creds
      - documentIndex: 1
        contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: other-secret

  - it: skips env file when config mode is ui
    set:
      paperlessGpt.enabled: true
      paperlessGpt.configMode: ui
    asserts:
      - documentIndex: 0
        notContains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: paperless-gpt-env
      - documentIndex: 0
        notContains:
          path: spec.template.spec.volumes
          content:
            name: paperless-gpt-env
