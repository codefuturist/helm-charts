{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "postgresql.fullname" . }}-backup-preupgrade
  namespace: {{ include "postgresql.namespace" . }}
  labels:
    {{- include "postgresql.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup
  annotations:
    "helm.sh/hook": pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "postgresql.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: backup
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "postgresql.serviceAccountName" . }}
      containers:
        - name: backup
          image: {{ .Values.backup.image.repository }}:{{ .Values.backup.image.tag }}
          imagePullPolicy: {{ .Values.backup.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              set -o pipefail

              BACKUP_FILE="/backups/postgresql-preupgrade-$(date +%Y%m%d-%H%M%S).sql.gz"
              echo "Starting pre-upgrade backup to $BACKUP_FILE"

              # Test database connection
              if ! pg_isready -h {{ include "postgresql.fullname" . }} -U ${POSTGRES_USER} -d ${POSTGRES_DB} -q; then
                echo "ERROR: PostgreSQL is not ready"
                exit 1
              fi

              # Perform backup
              if ! pg_dump -h {{ include "postgresql.fullname" . }} \
                -U ${POSTGRES_USER} \
                -d ${POSTGRES_DB} \
                --verbose \
                2>&1 | tee /tmp/backup.log | gzip > $BACKUP_FILE; then
                echo "ERROR: Pre-upgrade backup failed"
                cat /tmp/backup.log
                exit 1
              fi

              # Verify backup
              if [ ! -s "$BACKUP_FILE" ]; then
                echo "ERROR: Backup file is empty"
                exit 1
              fi

              BACKUP_SIZE=$(du -h $BACKUP_FILE | cut -f1)
              echo "Pre-upgrade backup completed successfully: $BACKUP_FILE ($BACKUP_SIZE)"
          env:
            - name: POSTGRES_USER
              value: {{ .Values.postgresql.username | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.postgresql.database | quote }}
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "postgresql.secretName" . }}
                  key: {{ include "postgresql.passwordKey" . }}
          {{- with .Values.backup.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: backup
              mountPath: /backups
      volumes:
        - name: backup
          {{- if .Values.backup.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ include "postgresql.fullname" . }}-backup
          {{- else }}
          emptyDir: {}
          {{- end }}
{{- end }}
