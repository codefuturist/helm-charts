suite: test diagnostic mode
templates:
  - statefulset.yaml
tests:
  - it: should override command when diagnostic mode enabled
    template: statefulset.yaml
    set:
      diagnosticMode.enabled: true
      diagnosticMode.command: ["sleep"]
      diagnosticMode.args: ["infinity"]
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["sleep"]
      - equal:
          path: spec.template.spec.containers[0].args
          value: ["infinity"]

  - it: should disable all probes when diagnostic mode enabled
    template: statefulset.yaml
    set:
      diagnosticMode.enabled: true
      deployment.livenessProbe.enabled: true
      deployment.readinessProbe.enabled: true
      deployment.startupProbe.enabled: true
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe
      - isNull:
          path: spec.template.spec.containers[0].readinessProbe
      - isNull:
          path: spec.template.spec.containers[0].startupProbe

  - it: should use normal command when diagnostic mode disabled
    template: statefulset.yaml
    set:
      diagnosticMode.enabled: false
      postgresql.config:
        max_connections: "100"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command
          value:
            - postgres
            - -c
            - config_file=/etc/postgresql/postgresql.conf

  - it: should enable probes when diagnostic mode disabled
    template: statefulset.yaml
    set:
      diagnosticMode.enabled: false
      deployment.livenessProbe.enabled: true
      deployment.readinessProbe.enabled: true
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].livenessProbe
      - isNotNull:
          path: spec.template.spec.containers[0].readinessProbe

  - it: should override init container command in diagnostic mode
    template: statefulset.yaml
    set:
      diagnosticMode.enabled: true
      diagnosticMode.command: ["sleep"]
      diagnosticMode.args: ["infinity"]
      replication.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.initContainers[?(@.name=="setup-replication")].command
          value: ["sleep"]
      - equal:
          path: spec.template.spec.initContainers[?(@.name=="setup-replication")].args
          value: ["infinity"]
