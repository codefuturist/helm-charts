# Example configuration for PostgreSQL with WAL (Write-Ahead Log) archiving
# This enables incremental backups for point-in-time recovery (PITR)

# =====================================================================
# Basic Configuration
# =====================================================================

postgresql:
  enabled: true

  # PostgreSQL version
  image:
    repository: postgres
    tag: "16.4-alpine"
    pullPolicy: IfNotPresent

  # Database configuration
  username: "postgres"
  database: "postgres"

  # PostgreSQL configuration - WAL level must be 'replica' or higher for archiving
  config:
    max_connections: "100"
    shared_buffers: "128MB"
    effective_cache_size: "4GB"
    maintenance_work_mem: "64MB"
    checkpoint_completion_target: "0.9"
    wal_buffers: "16MB"
    default_statistics_target: "100"
    random_page_cost: "1.1"
    effective_io_concurrency: "200"
    work_mem: "5242kB"
    huge_pages: "try"
    min_wal_size: "1GB"
    max_wal_size: "4GB"
    max_worker_processes: "2"
    max_parallel_workers_per_gather: "1"
    max_parallel_workers: "2"
    max_parallel_maintenance_workers: "1"
    # WAL configuration - required for archiving
    wal_level: "replica" # Required for WAL archiving
    archive_timeout: "300" # Archive WAL every 5 minutes even if not full

# =====================================================================
# Persistence
# =====================================================================

persistence:
  enabled: true
  storageClass: ""
  size: 20Gi
  accessModes:
    - ReadWriteOnce

# =====================================================================
# Deployment Configuration
# =====================================================================

deployment:
  type: "statefulset" # Recommended for production with backups
  replicaCount: 1

  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 500m
      memory: 1Gi

  # Pod Security (recommended)
  podSecurityContext:
    fsGroup: 999
    runAsUser: 999
    runAsNonRoot: true

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false # PostgreSQL needs write access

# =====================================================================
# Full Backup Configuration
# =====================================================================

backup:
  # Enable automated full backups
  enabled: true

  # Run full backup daily at 2 AM
  schedule: "0 2 * * *"

  # Keep 7 days of full backups
  retentionDays: 7

  # Backup storage
  persistence:
    enabled: true
    storageClass: ""
    size: 50Gi # Should be ~2-3x database size
    accessModes:
      - ReadWriteOnce

  # Optional: Upload to S3
  s3:
    enabled: false
    bucket: "my-postgres-backups"
    region: "us-east-1"
    # Use existingSecret for credentials
    existingSecret: "postgres-backup-s3-credentials"

  # =====================================================================
  # WAL Archiving Configuration (Incremental Backups)
  # =====================================================================

  wal:
    # Enable WAL archiving for incremental backups
    enabled: true

    # WAL archive method
    # Options: 'simple' (cp/gzip), 'wal-g', 'wal-e', 'pgbackrest'
    method: "simple"

    # Compression for WAL files
    # Options: 'none', 'gzip', 'lz4', 'zstd'
    compression: "gzip"

    # Keep WAL archives for 14 days (should be >= full backup retention)
    retentionDays: 14

    # WAL archive storage (for 'simple' method)
    persistence:
      enabled: true
      storageClass: ""
      size: 100Gi # WAL files can grow quickly
      mountPath: /wal-archive
      accessModes:
        - ReadWriteOnce

    # WAL cleanup job
    cleanup:
      enabled: true
      schedule: "0 3 * * *" # Run cleanup at 3 AM (after full backup)
      successfulJobsHistoryLimit: 1
      failedJobsHistoryLimit: 1

# =====================================================================
# Resources
# =====================================================================

# (Resources configured in deployment section above)

# =====================================================================
# Monitoring (Optional)
# =====================================================================

metrics:
  enabled: true

serviceMonitor:
  enabled: false # Enable if using Prometheus Operator
  interval: 30s

# =====================================================================
# Security
# =====================================================================

# Use secret management
existingSecret: "" # Set to use existing secret

# Network policy (optional)
networkPolicy:
  enabled: false
