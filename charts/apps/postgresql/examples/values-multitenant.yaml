# Example: Multi-tenant application with multiple databases and users
# This example shows how to configure PostgreSQL for a multi-tenant setup

postgresql:
  database: "postgres"
  username: "postgres"
  # password: will be auto-generated or use existingSecret

  # Enable extensions
  extensions:
    - pg_stat_statements
    - pgcrypto
    - uuid-ossp
    - pg_trgm

  # Create additional databases for different tenants/purposes
  # Note: Database ownership is automatically assigned to the first user with ALL privileges
  additionalDatabases:
    - name: tenant1_db
      # owner automatically set to tenant1_user
      encoding: UTF8
      lc_collate: en_US.UTF-8
      lc_ctype: en_US.UTF-8
      template: template0

    - name: tenant2_db
      # owner automatically set to tenant2_user
      encoding: UTF8
      lc_collate: en_US.UTF-8
      lc_ctype: en_US.UTF-8
      template: template0

    - name: shared_db
      # owner automatically set to app_admin
      encoding: UTF8

    - name: analytics_db
      owner: postgres # Explicitly set for system database
      encoding: UTF8

  # Create additional users with specific privileges
  additionalUsers:
    # Tenant 1 application user
    - username: tenant1_user
      existingSecret: tenant1-db-secret # Recommended: store password in secret
      databases:
        - tenant1_db
      privileges: ALL
      superuser: false
      createdb: false
      createrole: false

    # Tenant 2 application user
    - username: tenant2_user
      existingSecret: tenant2-db-secret
      databases:
        - tenant2_db
      privileges: ALL
      superuser: false
      createdb: false
      createrole: false

    # Application admin with access to all tenant databases
    - username: app_admin
      existingSecret: app-admin-secret
      databases:
        - tenant1_db
        - tenant2_db
        - shared_db
      privileges: ALL
      superuser: false
      createdb: true
      createrole: false

    # Read-only user for analytics/reporting
    - username: readonly_user
      existingSecret: readonly-secret
      databases:
        - tenant1_db
        - tenant2_db
        - analytics_db
      privileges: SELECT
      superuser: false
      createdb: false
      createrole: false

    # Analytics ETL user with write access to analytics db
    - username: analytics_etl
      existingSecret: analytics-etl-secret
      databases:
        - analytics_db
      privileges: ALL
      superuser: false
      createdb: false
      createrole: false

  # Custom init scripts for additional setup
  initScripts:
    10-create-schemas.sql: |
      -- Create schemas for multi-tenancy
      \c tenant1_db
      CREATE SCHEMA IF NOT EXISTS tenant1_schema AUTHORIZATION tenant1_user;

      \c tenant2_db
      CREATE SCHEMA IF NOT EXISTS tenant2_schema AUTHORIZATION tenant2_user;

    20-grant-permissions.sql: |
      -- Grant additional permissions
      \c tenant1_db
      GRANT USAGE ON SCHEMA tenant1_schema TO readonly_user;
      GRANT SELECT ON ALL TABLES IN SCHEMA tenant1_schema TO readonly_user;
      ALTER DEFAULT PRIVILEGES FOR USER tenant1_user IN SCHEMA tenant1_schema
        GRANT SELECT ON TABLES TO readonly_user;

      \c tenant2_db
      GRANT USAGE ON SCHEMA tenant2_schema TO readonly_user;
      GRANT SELECT ON ALL TABLES IN SCHEMA tenant2_schema TO readonly_user;
      ALTER DEFAULT PRIVILEGES FOR USER tenant2_user IN SCHEMA tenant2_schema
        GRANT SELECT ON TABLES TO readonly_user;

deployment:
  replicas: 1
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi

persistence:
  enabled: true
  size: 50Gi
  storageClass: "fast-ssd"

backup:
  enabled: true
  schedule: "0 2 * * *" # Daily at 2 AM
  retention: 7
  databases:
    - tenant1_db
    - tenant2_db
    - shared_db
    - analytics_db
