# Example: Using WEBPASSWORD_FILE with mounted secret
# This demonstrates the file-based secret approach supported by Pi-hole

# Create a secret with the password
# kubectl create secret generic pihole-password-file \
#   --from-literal=password='my-secure-password'

# Use existing secret (don't create one)
secret:
  enabled: false
  existingSecret: "pihole-password-file"

serviceAccount:
  enabled: true

deployment:
  replicas: 1

  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

  # Environment variables - use WEBPASSWORD_FILE instead of FTLCONF_webserver_api_password
  env:
    TZ:
      value: "Europe/Zurich"

    # Use WEBPASSWORD_FILE to read password from mounted secret file
    # This takes precedence over FTLCONF_webserver_api_password if both are set
    WEBPASSWORD_FILE:
      value: /run/secrets/pihole_password

    # Other configuration
    FTLCONF_dns_listeningMode:
      value: all
    FTLCONF_dns_upstreams:
      value: 8.8.8.8;8.8.4.4;1.1.1.1
    FTLCONF_dns_dnssec:
      value: "true"
    FTLCONF_database_DBfile:
      value: /etc/pihole/pihole-FTL.db
    FTLCONF_webserver_port:
      value: 80o,[::]:80o,443os,[::]:443os
    PIHOLE_UID:
      value: "1000"
    PIHOLE_GID:
      value: "1000"

  # Mount the secret as a file
  volumes:
    - name: etc-pihole
      type: emptyDir
      mountPath: /etc/pihole
      readOnly: false
    - name: etc-dnsmasq-d
      type: emptyDir
      mountPath: /etc/dnsmasq.d
      readOnly: false
    # Mount secret as a file at /run/secrets/pihole_password
    - name: pihole-password
      type: secret
      mountPath: /run/secrets/pihole_password
      secretName: pihole-password-file
      readOnly: true
      items:
        - key: password
          path: pihole_password

service:
  type: ClusterIP
  port: 80

---
# How to use this configuration:
#
# 1. Create a secret with the password:
#    kubectl create secret generic pihole-password-file \
#      --from-literal=password='my-secure-password' \
#      -n pihole-test
#
# 2. Install the chart:
#    helm install pihole ./pihole -n pihole-test -f examples/values-webpassword-file.yaml
#
# 3. Pi-hole will read the password from /run/secrets/pihole_password
#
# 4. Access Pi-hole:
#    kubectl port-forward svc/pihole 8080:80 -n pihole-test
#    Visit: http://localhost:8080/admin
#    Login with: my-secure-password
#
# Benefits of WEBPASSWORD_FILE:
# ✅ File-based secrets (Docker Secrets compatible)
# ✅ More secure than environment variables (not visible in process list)
# ✅ Kubernetes-native secret mounting
# ✅ Can use any secret management solution
# ✅ Password not exposed via `kubectl describe pod`
#
# Note: If FTLCONF_webserver_api_password is also set, it takes precedence over WEBPASSWORD_FILE
