# Example: Using Sealed Secrets with Pi-hole
# Sealed Secrets allows you to store encrypted secrets in Git safely
# The SealedSecret can only be decrypted by the controller running in the cluster

# Prerequisites:
# 1. Install Sealed Secrets controller: https://github.com/bitnami-labs/sealed-secrets
#    kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml
# 2. Install kubeseal CLI: https://github.com/bitnami-labs/sealed-secrets#installation
#    brew install kubeseal  (macOS)
#    choco install kubeseal  (Windows)

# How to create a sealed secret:
# 1. Create a regular secret (don't apply it):
#    kubectl create secret generic pihole-secrets \
#      --from-literal=WEBPASSWORD='my-secure-password' \
#      --from-literal=FTLCONF_webserver_api_password='my-api-password' \
#      --dry-run=client -o yaml > secret.yaml
#
# 2. Seal the secret:
#    kubeseal -f secret.yaml -w sealedsecret.yaml
#
# 3. Copy the encrypted values to this file
# 4. Delete the unencrypted secret.yaml (never commit it!)
# 5. You can safely commit sealedsecret.yaml to Git

# Enable Sealed Secrets
sealedSecrets:
  enabled: true

  # Sealed secret scope determines where it can be used:
  # - strict: Only this namespace with this exact name (most secure)
  # - namespace-wide: Any name in the same namespace
  # - cluster-wide: Anywhere in the cluster
  scope: strict

  # Encrypted secret data (generated by kubeseal)
  # IMPORTANT: Replace these with your actual encrypted values!
  encryptedData:
    WEBPASSWORD: AgBZ8VzTxW5... # YOUR ENCRYPTED VALUE HERE
    FTLCONF_webserver_api_password: AgAZKp3MnRq... # YOUR ENCRYPTED VALUE HERE

  # Optional annotations
  annotations:
    sealedsecrets.bitnami.com/managed: "true"

# Don't create a regular secret
secret:
  enabled: false

deployment:
  replicas: 2

  # Use the sealed secret in environment variables
  env:
    TZ:
      value: "America/New_York"

    FTLCONF_webserver_api_password:
      valueFrom:
        secretKeyRef:
          name: pihole-test # Will be decrypted and created by Sealed Secrets controller
          key: FTLCONF_webserver_api_password

    FTLCONF_dns_listeningMode:
      value: all

  volumes:
    - name: etc-pihole
      type: emptyDir
      mountPath: /etc/pihole
    - name: etc-dnsmasq-d
      type: emptyDir
      mountPath: /etc/dnsmasq.d

service:
  type: ClusterIP

---
# Complete workflow for using Sealed Secrets:
#
# 1. Create the secret:
#    echo -n "my-password" | kubectl create secret generic pihole-secrets \
#      --dry-run=client --from-file=WEBPASSWORD=/dev/stdin -o yaml > /tmp/secret.yaml
#
# 2. Seal it:
#    kubeseal -f /tmp/secret.yaml -o yaml | grep "WEBPASSWORD:" | awk '{print $2}'
#
# 3. Copy the encrypted value to this file
#
# 4. Install the chart:
#    helm install pihole ./pihole -f examples/values-sealed-secrets.yaml
#
# 5. The Sealed Secrets controller will automatically decrypt and create the real Secret
#
# Benefits:
# ✅ Safe to commit to Git
# ✅ GitOps friendly
# ✅ Automatic encryption/decryption
# ✅ Works with existing Kubernetes RBAC
# ✅ No external dependencies (self-contained)
