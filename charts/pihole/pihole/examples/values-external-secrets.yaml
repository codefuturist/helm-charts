# Example: Using External Secrets Operator with Pi-hole
# This example shows how to integrate with AWS Secrets Manager, Azure Key Vault,
# GCP Secret Manager, HashiCorp Vault, or other secret backends

# Prerequisites:
# 1. Install External Secrets Operator: https://external-secrets.io/latest/introduction/getting-started/
# 2. Create a SecretStore or ClusterSecretStore for your backend
# 3. Store secrets in your external secret manager

# Example SecretStore for AWS Secrets Manager (create separately):
# ---
# apiVersion: external-secrets.io/v1beta1
# kind: SecretStore
# metadata:
#   name: aws-secretsmanager
#   namespace: default
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: us-east-1
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: pihole

# Enable External Secrets Operator integration
externalSecrets:
  enabled: true

  # Name of the SecretStore to use
  secretStoreName: "aws-secretsmanager"
  secretStoreKind: SecretStore  # or ClusterSecretStore

  # How often to sync from external secret store
  refreshInterval: 1h

  # Target secret configuration
  target:
    name: ""  # Leave empty to use chart fullname
    creationPolicy: Owner  # Operator manages the secret lifecycle
    deletionPolicy: Retain  # Keep secret when ExternalSecret is deleted

  # Map external secrets to Kubernetes secret keys
  data:
    # Fetch web password from AWS Secrets Manager
    - secretKey: WEBPASSWORD
      remoteRef:
        key: prod/pihole/webpassword  # Path in AWS Secrets Manager

    # Fetch API password
    - secretKey: FTLCONF_webserver_api_password
      remoteRef:
        key: prod/pihole/api-password

    # You can also fetch from JSON secrets
    # - secretKey: SOME_CONFIG
    #   remoteRef:
    #     key: prod/pihole/config
    #     property: someField  # Extract specific field from JSON

  # Optional: Transform secrets using templates
  template:
    engineVersion: v2
    # data:
    #   # Combine or transform secrets
    #   COMBINED: "{{ .WEBPASSWORD }}-suffix"

# Don't create a regular secret
secret:
  enabled: false

deployment:
  replicas: 2

  # Use the External Secret in environment variables
  env:
    TZ:
      value: "America/New_York"

    FTLCONF_webserver_api_password:
      valueFrom:
        secretKeyRef:
          name: pihole-test  # Will be created by ExternalSecret (or specify externalSecrets.target.name)
          key: FTLCONF_webserver_api_password

    FTLCONF_dns_listeningMode:
      value: all

  volumes:
  - name: etc-pihole
    type: emptyDir
    mountPath: /etc/pihole
  - name: etc-dnsmasq-d
    type: emptyDir
    mountPath: /etc/dnsmasq.d

service:
  type: ClusterIP

---
# How to use with different providers:
#
# Azure Key Vault:
# externalSecrets:
#   secretStoreName: "azure-keyvault"
#   data:
#     - secretKey: WEBPASSWORD
#       remoteRef:
#         key: pihole-webpassword  # Name in Azure Key Vault
#
# GCP Secret Manager:
# externalSecrets:
#   secretStoreName: "gcp-secretmanager"
#   data:
#     - secretKey: WEBPASSWORD
#       remoteRef:
#         key: projects/123456/secrets/pihole-webpassword
#
# HashiCorp Vault:
# externalSecrets:
#   secretStoreName: "vault"
#   data:
#     - secretKey: WEBPASSWORD
#       remoteRef:
#         key: secret/data/pihole
#         property: webpassword
