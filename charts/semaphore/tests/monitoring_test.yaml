suite: test uptime-kuma monitoring
templates:
  - servicemonitor.yaml
  - prometheusrule.yaml
  - hpa.yaml
tests:
  - it: should not create ServiceMonitor by default
    template: servicemonitor.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ServiceMonitor when enabled
    template: servicemonitor.yaml
    set:
      monitoring.serviceMonitor.enabled: true
    asserts:
      - isKind:
          of: ServiceMonitor
      - equal:
          path: metadata.name
          value: RELEASE-NAME-uptime-kuma
      - equal:
          path: spec.endpoints[0].interval
          value: 60s

  - it: should configure ServiceMonitor with custom settings
    template: servicemonitor.yaml
    set:
      monitoring.serviceMonitor.enabled: true
      monitoring.serviceMonitor.interval: "30s"
      monitoring.serviceMonitor.scrapeTimeout: "20s"
    asserts:
      - equal:
          path: spec.endpoints[0].interval
          value: "30s"
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: "20s"

  - it: should not create PrometheusRule by default
    template: prometheusrule.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create PrometheusRule when enabled
    template: prometheusrule.yaml
    set:
      monitoring.prometheusRule.enabled: true
      monitoring.prometheusRule.rules[0].alert: "UptimeKumaDown"
      monitoring.prometheusRule.rules[0].expr: "up == 0"
    asserts:
      - isKind:
          of: PrometheusRule
      - equal:
          path: metadata.name
          value: RELEASE-NAME-uptime-kuma

  - it: should not create HPA by default
    template: hpa.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should create HPA when enabled
    template: hpa.yaml
    set:
      hpa.enabled: true
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - equal:
          path: metadata.name
          value: RELEASE-NAME-uptime-kuma
      - equal:
          path: spec.minReplicas
          value: 1
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should configure HPA with custom metrics
    template: hpa.yaml
    set:
      hpa.enabled: true
      hpa.minReplicas: 2
      hpa.maxReplicas: 5
      hpa.targetCPU: 80
    asserts:
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 5
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 80
