# Unprivileged Home Assistant Configuration (Recommended)
# Secure setup using specific capabilities instead of privileged mode
# Based on unprivileged Docker Compose best practices

# =============================================================================
# This configuration provides a secure, unprivileged setup:
# - NO privileged mode (better security)
# - Specific Linux capabilities only (NET_ADMIN, NET_RAW, SYS_ADMIN)
# - Bridge networking (not host network)
# - Named volumes with proper configuration
# - Environment variable configuration
# =============================================================================

# Image configuration with environment-based override support
image:
  repository: ghcr.io/home-assistant/home-assistant
  tag: "stable" # Can be overridden via env var
  pullPolicy: IfNotPresent

# Single replica
replicaCount: 1

# Recreate strategy for safe updates
strategy:
  type: Recreate

# =============================================================================
# Persistence - Named Volume Configuration
# =============================================================================
persistence:
  enabled: true
  size: 20Gi
  storageClassName: ""
  retain: true
  # Annotations for backup and labeling (matches Docker volume labels)
  annotations:
    backup.velero.io/backup-volumes: "config"
    description: "Home Assistant configuration"
    department: "IT"
    backup: "daily"

# =============================================================================
# Service - Bridge Network with Port Mapping
# =============================================================================
# Using ClusterIP/LoadBalancer instead of host network (more secure)
service:
  type: LoadBalancer # Or use ClusterIP with Ingress
  port: 8123
  annotations: {}
  # For specific IP assignment:
  # loadBalancerIP: "192.168.1.100"

# =============================================================================
# Networking - No Host Network (More Secure)
# =============================================================================
# Bridge networking instead of host network
# This provides better isolation and security
hostNetwork:
  enabled: false # Disabled for better security

# =============================================================================
# System Volumes - Timezone Sync
# =============================================================================
systemVolumes:
  # Mount /etc/localtime for timezone synchronization
  localtime:
    enabled: true
    hostPath: /etc/localtime

  # D-Bus not needed in unprivileged mode
  dbus:
    enabled: false

# =============================================================================
# Device Access - Specific USB Devices Only
# =============================================================================
# Add specific devices as needed (Z-Wave, Zigbee controllers)
devices:
  enabled: false # Enable if you have USB devices
  list: []
    # Uncomment and configure your devices:
    # - hostPath: /dev/ttyUSB0
    #   containerPath: /dev/ttyUSB0
    # - hostPath: /dev/ttyACM0
    #   containerPath: /dev/ttyACM0

# =============================================================================
# Home Assistant Configuration
# =============================================================================
homeassistant:
  env:
    # Timezone from environment variable
    TZ: "Europe/Zurich" # Can be overridden

  # For environment-based configuration
  # envFrom:
  #   - configMapRef:
  #       name: homeassistant-env

# =============================================================================
# Security Context - Unprivileged with Specific Capabilities (RECOMMENDED)
# =============================================================================
podSecurityContext:
  # Run as root but with limited capabilities
  runAsNonRoot: false
  runAsUser: 0
  runAsGroup: 0
  fsGroup: 0
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
    # Add ONLY the capabilities needed (much safer than privileged: true)
    add:
      - NET_ADMIN # For network discovery (mDNS, SSDP)
      - NET_RAW # For ping integration and network scanning
      - SYS_ADMIN # For some hardware access (use carefully)
  readOnlyRootFilesystem: false
  # IMPORTANT: privileged is FALSE (secure configuration)
  privileged: false

# =============================================================================
# Resources - Balanced Configuration
# =============================================================================
resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

# =============================================================================
# Database - SQLite (Default)
# =============================================================================
database:
  type: sqlite

# =============================================================================
# Probes - Standard Configuration
# =============================================================================
livenessProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

readinessProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30

# =============================================================================
# Restart Policy - Automatic Restart on Failure
# =============================================================================
# Kubernetes handles this automatically with ReplicaSet
# Similar to Docker Compose: restart: unless-stopped
# Additional control via:
podDisruptionBudget:
  enabled: false
  minAvailable: 1

# =============================================================================
# Optional Add-ons (Disabled by Default)
# =============================================================================
codeserver:
  enabled: false

mqtt:
  enabled: false

ingress:
  enabled: false

serviceMonitor:
  enabled: false
# =============================================================================
# Deployment Instructions
# =============================================================================
#
# This configuration provides SECURE unprivileged operation with:
# ✅ Specific capabilities instead of full privileged mode
# ✅ Bridge networking instead of host network
# ✅ Better security isolation
# ✅ Environment variable support
# ✅ Proper restart handling
# ✅ Volume labels for backup integration
#
# Deploy:
# -------
# 1. Basic deployment:
#    helm install home-assistant codefuturist/home-assistant \
#      -f examples/values-unprivileged.yaml
#
# 2. With environment overrides:
#    helm install home-assistant codefuturist/home-assistant \
#      -f examples/values-unprivileged.yaml \
#      --set homeassistant.env.TZ="America/New_York" \
#      --set image.tag="2024.11.1"
#
# 3. With USB devices:
#    helm install home-assistant codefuturist/home-assistant \
#      -f examples/values-unprivileged.yaml \
#      --set devices.enabled=true \
#      --set devices.list[0].hostPath=/dev/ttyUSB0 \
#      --set devices.list[0].containerPath=/dev/ttyUSB0
#
# Access:
# -------
# kubectl get svc home-assistant
# # Note the EXTERNAL-IP (if LoadBalancer)
# # Or use port-forward: kubectl port-forward svc/home-assistant 8123:8123
#
# Security Advantages:
# --------------------
# ✅ No privileged mode - reduced attack surface
# ✅ Specific capabilities only - principle of least privilege
# ✅ Bridge networking - better network isolation
# ✅ Standard Kubernetes security - integrates with policies
# ✅ Easier to audit - clear capability requirements
# ✅ Compatible with most security policies and PSPs
#
# When to use this configuration:
# --------------------------------
# ✅ Production environments
# ✅ Security-conscious deployments
# ✅ Compliance requirements
# ✅ Multi-tenant clusters
# ✅ When you don't need Bluetooth or full system access
# ✅ Standard Home Assistant setups (most users)
#
# When you might need privileged mode instead:
# --------------------------------------------
# ❌ Bluetooth integrations (requires privileged or host network)
# ❌ Full system D-Bus access
# ❌ Certain exotic hardware requirements
# ❌ Legacy integrations that require full root access
#
# Migration from Docker Compose:
# -------------------------------
# This configuration closely matches the unprivileged Docker Compose setup:
#
# Docker Compose Feature          → Kubernetes Equivalent
# ═══════════════════════════════════════════════════════════════
# cap_add: NET_ADMIN              → capabilities.add: [NET_ADMIN]
# cap_add: NET_RAW                → capabilities.add: [NET_RAW]
# cap_add: SYS_ADMIN              → capabilities.add: [SYS_ADMIN]
# restart: unless-stopped         → ReplicaSet auto-restart
# deploy.restart_policy           → Native Kubernetes handling
# networks: bridge                → Default Kubernetes networking
# ports: 8123:8123               → service.port: 8123
# volumes with labels             → PVC with annotations
# devices: /dev/ttyUSB0          → devices.list configuration
# environment: TZ                 → homeassistant.env.TZ
#
# Troubleshooting:
# ----------------
# 1. Network discovery not working?
#    - Check if NET_ADMIN capability is added
#    - Some integrations may need host network mode
#    - Consider values-docker-compose.yaml for full compatibility
#
# 2. Ping integration failing?
#    - Ensure NET_RAW capability is added
#    - Check pod security policies aren't blocking it
#
# 3. Device access issues?
#    - Verify devices are properly mounted
#    - Check device permissions on host node
#    - Ensure node selector targets correct node
#
# 4. Need more capabilities?
#    - Add specific capabilities one at a time
#    - Test each addition for security impact
#    - Document why each capability is needed
