name: Release Chartsname: Release

on:

on:  push:

  push:    tags:

    branches:      - "v*"

      - main

    paths:jobs:

      - 'charts/**'  build:

    name: Release

permissions:    runs-on: ubuntu-latest

  contents: write

  pages: write    steps:

  id-token: write      - name: Check out code

        uses: actions/checkout@v4

jobs:        with:

  release:          fetch-depth: 0 # See: https://goreleaser.com/ci/actions/

    runs-on: ubuntu-latest

    steps:      - name: Create Release

      - name: Checkout        id: create_release

        uses: actions/checkout@v4        uses: actions/create-release@v1

        with:        env:

          fetch-depth: 0          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        with:

      - name: Configure Git          tag_name: ${{ github.ref }}

        run: |          release_name: ${{ github.ref }}

          git config user.name "$GITHUB_ACTOR"          draft: false

          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"          prerelease: false



      - name: Install Helm      - name: Notify Slack

        uses: azure/setup-helm@v4        uses: 8398a7/action-slack@v3

        with:        if: always()

          version: v3.13.0        with:

          status: ${{ job.status }}

      - name: Add dependencies          fields: repo,author,action,eventName,ref,workflow

        run: |        env:

          for dir in charts/*/; do          SLACK_WEBHOOK_URL: ${{ secrets.STAKATER_DELIVERY_SLACK_WEBHOOK }}

            if [ -f "$dir/Chart.yaml" ]; then
              echo "Checking dependencies for $dir"
              helm dependency update "$dir" || true
            fi
          done

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          charts_dir: charts
          skip_existing: true

      - name: Update index.yaml for root
        run: |
          git checkout gh-pages
          cp index.yaml /tmp/index.yaml
          git checkout main
          cp /tmp/index.yaml ./index.yaml
          git add index.yaml
          git commit -m "Update index.yaml from gh-pages" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"
