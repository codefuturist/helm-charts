name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - "charts/apps/**"
      - "charts/libs/**"
      - "charts/vendors/**"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Build chart dependencies
        run: |
          # Build dependencies for charts in apps, libs, and vendors
          for chart_dir in charts/apps charts/libs charts/vendors; do
            if [ -d "$chart_dir" ]; then
              find "$chart_dir" -maxdepth 2 -name "Chart.yaml" -type f | while read chart_file; do
                dir=$(dirname "$chart_file")
                # Skip if it's a subchart dependency
                if [[ "$dir" == */charts/* ]]; then
                  continue
                fi
                if grep -q "^dependencies:" "$chart_file" 2>/dev/null; then
                  echo "Building dependencies for $dir"
                  helm dependency build "$dir" || echo "Warning: Failed to build deps for $dir"
                fi
              done
            fi
          done

      - name: Run chart-releaser for apps
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          charts_dir: charts/apps
          skip_existing: true

      - name: Run chart-releaser for libs
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          charts_dir: charts/libs
          skip_existing: true
