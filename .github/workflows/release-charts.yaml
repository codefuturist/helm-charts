name: Release Charts

on:
    push:
        branches:
            - main
        paths:
            - "charts/**"

permissions:
    contents: write
    pages: write
    id-token: write

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Configure Git
              run: |
                  git config user.name "$GITHUB_ACTOR"
                  git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

            - name: Install Helm
              uses: azure/setup-helm@v4
              with:
                  version: v3.13.0

            - name: Add dependencies
              run: |
                  for dir in charts/*/; do
                    if [ -f "$dir/Chart.yaml" ]; then
                      echo "Checking dependencies for $dir"
                      helm dependency update "$dir" || true
                    fi
                  done

            - name: Run chart-releaser
              uses: helm/chart-releaser-action@v1.6.0
              env:
                  CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
              with:
                  charts_dir: charts
                  skip_existing: true

            - name: Update index.yaml for root
              run: |
                  git checkout gh-pages
                  cp index.yaml /tmp/index.yaml
                  git checkout main
                  cp /tmp/index.yaml ./index.yaml
                  git add index.yaml
                  git commit -m "Update index.yaml from gh-pages" || echo "No changes to commit"
                  git push origin main || echo "Nothing to push"
