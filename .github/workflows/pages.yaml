name: Deploy GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - "site/**"
      - "charts/apps/**/README.md"
      - "charts/apps/**/Chart.yaml"
      - "charts/apps/**/values.yaml"
      - "charts/libs/**/README.md"
      - "charts/libs/**/Chart.yaml"
      - "charts/libs/**/values.yaml"
      - ".github/workflows/pages.yaml"
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Install helm-docs
        run: |
          cd /tmp
          wget https://github.com/norwoodj/helm-docs/releases/download/v1.14.2/helm-docs_1.14.2_Linux_x86_64.tar.gz
          tar -xzf helm-docs_1.14.2_Linux_x86_64.tar.gz
          sudo mv helm-docs /usr/local/bin/
          helm-docs --version

      - name: Generate chart documentation
        run: |
          echo "Generating documentation for all charts..."
          helm-docs --chart-search-root=charts/apps
          helm-docs --chart-search-root=charts/libs

      - name: Build site with chart documentation
        run: |
          echo "Setting up documentation structure..."

          # Create charts directory structure in site
          mkdir -p site/charts

          # Process charts from apps and libs directories
          for chart_category in apps libs; do
            for chart_dir in charts/$chart_category/*/; do
              chart_name=$(basename "$chart_dir")

              # Skip non-chart directories
              if [ ! -f "$chart_dir/Chart.yaml" ]; then
                echo "Skipping $chart_name (no Chart.yaml)"
                continue
              fi

              echo "Processing chart: $chart_name"

              # Create chart directory in site
              mkdir -p "site/charts/$chart_name"

              # Copy README if it exists
              if [ -f "$chart_dir/README.md" ]; then
                cp "$chart_dir/README.md" "site/charts/$chart_name/"
                echo "‚úì Copied README for $chart_name"
              fi

              # Copy Chart.yaml for reference
              if [ -f "$chart_dir/Chart.yaml" ]; then
                cp "$chart_dir/Chart.yaml" "site/charts/$chart_name/"
                echo "‚úì Copied Chart.yaml for $chart_name"
              fi

              # Copy values.yaml for reference
              if [ -f "$chart_dir/values.yaml" ]; then
                cp "$chart_dir/values.yaml" "site/charts/$chart_name/"
                echo "‚úì Copied values.yaml for $chart_name"
              fi
            done
          done

          # Generate charts index page
          cat > site/charts/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Chart Documentation - Pandia Helm Charts</title>
              <link rel="icon" href="https://helm.sh/img/helm.svg" type="image/svg+xml">
              <style>
                  :root {
                      --primary-color: #0f1689;
                      --secondary-color: #326ce5;
                      --accent-color: #00d4aa;
                      --bg-light: #f8f9fa;
                      --border-color: #dee2e6;
                      --text-dark: #2c3e50;
                      --text-light: #6c757d;
                  }
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                      line-height: 1.6;
                      color: var(--text-dark);
                      background-color: var(--bg-light);
                  }
                  header {
                      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                      color: white;
                      padding: 2rem;
                      text-align: center;
                  }
                  header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
                  header p { opacity: 0.9; }
                  .container { max-width: 1200px; margin: 2rem auto; padding: 2rem; }
                  .back-link {
                      display: inline-flex;
                      align-items: center;
                      gap: 0.5rem;
                      margin-bottom: 2rem;
                      color: var(--secondary-color);
                      text-decoration: none;
                      font-weight: 500;
                  }
                  .back-link:hover { text-decoration: underline; }
                  .chart-list {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                      gap: 1.5rem;
                  }
                  .chart-card {
                      background: white;
                      border-radius: 12px;
                      padding: 1.5rem;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                      border-left: 4px solid var(--secondary-color);
                      transition: transform 0.2s ease, box-shadow 0.2s ease;
                  }
                  .chart-card:hover {
                      transform: translateY(-4px);
                      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
                  }
                  .chart-card h2 {
                      color: var(--primary-color);
                      margin-bottom: 0.5rem;
                      font-size: 1.25rem;
                  }
                  .chart-card .version {
                      display: inline-block;
                      background: var(--accent-color);
                      color: white;
                      padding: 0.2rem 0.6rem;
                      border-radius: 12px;
                      font-size: 0.75rem;
                      font-weight: 600;
                      margin-bottom: 0.75rem;
                  }
                  .chart-card p {
                      color: var(--text-light);
                      margin-bottom: 1rem;
                      font-size: 0.9rem;
                  }
                  .chart-links {
                      display: flex;
                      flex-wrap: wrap;
                      gap: 0.5rem;
                  }
                  .chart-links a {
                      display: inline-flex;
                      align-items: center;
                      gap: 0.25rem;
                      padding: 0.4rem 0.8rem;
                      background: var(--secondary-color);
                      color: white;
                      text-decoration: none;
                      border-radius: 6px;
                      font-size: 0.85rem;
                      transition: background 0.2s ease;
                  }
                  .chart-links a:hover { background: var(--primary-color); }
                  footer {
                      text-align: center;
                      padding: 2rem;
                      color: var(--text-light);
                      font-size: 0.85rem;
                  }
              </style>
          </head>
          <body>
              <header>
                  <h1>üìö Chart Documentation</h1>
                  <p>Detailed documentation for all available Helm charts</p>
              </header>
              <div class="container">
                  <a href="../" class="back-link">‚Üê Back to Home</a>
                  <div class="chart-list" id="chart-list">
          HTMLEOF

          # Add a card for each chart
          for chart_dir in charts/*/; do
            chart_name=$(basename "$chart_dir")
            if [ -f "$chart_dir/Chart.yaml" ]; then
              description=$(grep "^description:" "$chart_dir/Chart.yaml" | sed 's/description: //' | sed 's/^"//' | sed 's/"$//' | head -1)
              version=$(grep "^version:" "$chart_dir/Chart.yaml" | awk '{print $2}' | head -1)

              cat >> site/charts/index.html << HTMLEOF
                      <div class="chart-card">
                          <h2>$chart_name</h2>
                          <span class="version">v$version</span>
                          <p>$description</p>
                          <div class="chart-links">
                              <a href="$chart_name/">üìñ README</a>
                              <a href="$chart_name/Chart.yaml">üìã Chart.yaml</a>
                              <a href="$chart_name/values.yaml">‚öôÔ∏è values.yaml</a>
                          </div>
                      </div>
          HTMLEOF
            fi
          done

          cat >> site/charts/index.html << 'HTMLEOF'
                  </div>
              </div>
              <footer>
                  <p>Generated automatically from chart sources</p>
              </footer>
          </body>
          </html>
          HTMLEOF

          echo "‚úì Site build complete"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

