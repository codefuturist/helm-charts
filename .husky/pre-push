#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# Pre-Push Hook - Developer Friendly Version
# =============================================================================
# - Runs tests before push (if available)
# - Non-blocking warnings
# - Timeout protection
# - Can be skipped with: git push --no-verify
# =============================================================================

set +e  # Don't exit on first error

TIMEOUT_SECONDS=120  # 2 minutes for tests
WARNINGS=0

echo "ğŸš€ Running pre-push checks..."
echo ""

# =============================================================================
# Helper Functions
# =============================================================================

run_with_timeout() {
    local timeout=$1
    shift
    local description=$1
    shift
    
    if command -v timeout >/dev/null 2>&1; then
        timeout "$timeout" "$@"
    elif command -v gtimeout >/dev/null 2>&1; then
        gtimeout "$timeout" "$@"
    else
        "$@"
    fi
    
    local exit_code=$?
    
    if [ $exit_code -eq 124 ] || [ $exit_code -eq 143 ]; then
        echo "â±ï¸  $description timed out after ${timeout}s (continuing...)"
        return 0
    fi
    
    return $exit_code
}

warn() {
    echo "âš ï¸  $1"
    WARNINGS=$((WARNINGS + 1))
}

# =============================================================================
# Check 1: Protected Branches (INFO ONLY)
# =============================================================================

current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
    echo "â„¹ï¸  Pushing to protected branch: $current_branch"
    echo "   Make sure you have permission to push directly"
    echo ""
fi

# =============================================================================
# Check 2: Unpushed Commits Count (INFO ONLY)
# =============================================================================

remote_name=$(git remote | head -1)
if [ -n "$remote_name" ]; then
    unpushed=$(git log --oneline "$remote_name/$current_branch..$current_branch" 2>/dev/null | wc -l | tr -d ' ')
    
    if [ "$unpushed" -gt 0 ]; then
        echo "ğŸ“Š Pushing $unpushed commit(s) to $remote_name/$current_branch"
        echo ""
    fi
fi

# =============================================================================
# Check 3: Run Tests (WARNING ONLY)
# =============================================================================

if [ -f "Makefile" ] && grep -q "^test:" Makefile 2>/dev/null; then
    echo "ğŸ§ª Running tests (timeout: ${TIMEOUT_SECONDS}s)..."
    
    if run_with_timeout $TIMEOUT_SECONDS "Tests" make test 2>&1 | tail -20; then
        echo "âœ… Tests passed"
    else
        warn "Tests failed or timed out"
        echo "   Review test output above"
        echo "   To skip: git push --no-verify"
    fi
    echo ""
elif [ -f "package.json" ] && grep -q '"test"' package.json 2>/dev/null; then
    echo "ğŸ§ª Running npm tests (timeout: ${TIMEOUT_SECONDS}s)..."
    
    if run_with_timeout $TIMEOUT_SECONDS "npm tests" npm test 2>&1 | tail -20; then
        echo "âœ… Tests passed"
    else
        warn "Tests failed or timed out"
        echo "   Review test output above"
        echo "   To skip: git push --no-verify"
    fi
    echo ""
else
    echo "â„¹ï¸  No test suite found (skipping)"
    echo ""
fi

# =============================================================================
# Check 4: Lint Check (WARNING ONLY)
# =============================================================================

if [ -f "Makefile" ] && grep -q "^lint:" Makefile 2>/dev/null; then
    echo "ğŸ” Running linters (timeout: 60s)..."
    
    if run_with_timeout 60 "Linters" make lint 2>&1 | tail -30; then
        echo "âœ… Linters passed"
    else
        warn "Linters found issues"
        echo "   Fix with: make lint-fix"
        echo "   Or skip: git push --no-verify"
    fi
    echo ""
else
    echo "â„¹ï¸  No linter configuration found (skipping)"
    echo ""
fi

# =============================================================================
# Check 5: Build Check (WARNING ONLY)
# =============================================================================

if [ -f "Makefile" ] && grep -q "^build:" Makefile 2>/dev/null; then
    echo "ğŸ”¨ Testing build (timeout: 60s)..."
    
    if run_with_timeout 60 "Build" make build 2>&1 | tail -20; then
        echo "âœ… Build successful"
    else
        warn "Build failed or timed out"
        echo "   Fix build errors before pushing"
        echo "   Or skip: git push --no-verify"
    fi
    echo ""
fi

# =============================================================================
# Check 6: Dependency Check (INFO ONLY)
# =============================================================================

if [ -f "package.json" ]; then
    if [ ! -d "node_modules" ]; then
        echo "â„¹ï¸  Node modules not installed"
        echo "   Run: npm install"
        echo ""
    fi
fi

# =============================================================================
# Summary
# =============================================================================

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

if [ $WARNINGS -gt 0 ]; then
    echo "âš ï¸  Pre-push checks completed with $WARNINGS warning(s)"
    echo ""
    echo "   Review warnings above before pushing"
    echo "   To skip warnings: git push --no-verify"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # Ask for confirmation
    printf "Continue with push? [Y/n] "
    read -r response
    
    if [ "$response" = "n" ] || [ "$response" = "N" ]; then
        echo "âŒ Push cancelled"
        exit 1
    fi
fi

echo "âœ… Pre-push checks complete - proceeding with push"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
exit 0
