#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# Post-Merge Hook - Developer Friendly Helper
# =============================================================================
# - Checks for dependency changes
# - Reminds about database migrations
# - Checks for config changes
# - All non-blocking
# =============================================================================

echo "ğŸ”„ Post-merge checks..."
echo ""

CHANGES_DETECTED=0

# =============================================================================
# Check 1: Package Dependencies Changed
# =============================================================================

if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '^package\.json$|^package-lock\.json$|^yarn\.lock$|^Gemfile\.lock$|^Pipfile\.lock$|^composer\.lock$|^go\.mod$|^Cargo\.lock$'; then
    echo "ğŸ“¦ Dependencies changed!"
    echo ""
    
    if [ -f "package.json" ]; then
        echo "   Run: npm install"
    fi
    
    if [ -f "Gemfile" ]; then
        echo "   Run: bundle install"
    fi
    
    if [ -f "Pipfile" ]; then
        echo "   Run: pipenv install"
    fi
    
    if [ -f "requirements.txt" ]; then
        echo "   Run: pip install -r requirements.txt"
    fi
    
    if [ -f "composer.json" ]; then
        echo "   Run: composer install"
    fi
    
    if [ -f "go.mod" ]; then
        echo "   Run: go mod download"
    fi
    
    if [ -f "Cargo.toml" ]; then
        echo "   Run: cargo build"
    fi
    
    echo ""
    CHANGES_DETECTED=1
fi

# =============================================================================
# Check 2: Database Migrations
# =============================================================================

if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '^db/migrate/|^migrations/|^database/migrations/'; then
    echo "ğŸ—„ï¸  Database migrations detected!"
    echo "   Run: make migrate"
    echo "   Or: rails db:migrate / alembic upgrade head"
    echo ""
    CHANGES_DETECTED=1
fi

# =============================================================================
# Check 3: Configuration Files Changed
# =============================================================================

if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '\.env\.example$|config.*\.yml$|\.config/'; then
    echo "âš™ï¸  Configuration files changed!"
    echo "   Review and update your local config files"
    echo ""
    CHANGES_DETECTED=1
fi

# =============================================================================
# Check 4: Docker Changes
# =============================================================================

if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '^Dockerfile$|^docker-compose\.yml$|^\.dockerignore$'; then
    echo "ğŸ³ Docker files changed!"
    echo "   Run: docker-compose build"
    echo "   Or: docker build ."
    echo ""
    CHANGES_DETECTED=1
fi

# =============================================================================
# Check 5: Git Hooks Changed
# =============================================================================

if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '^\.husky/|^\.pre-commit-config\.yaml$'; then
    echo "ğŸª Git hooks changed!"
    echo "   Hooks will be automatically updated"
    echo "   Run: make setup-hooks (if needed)"
    echo ""
    CHANGES_DETECTED=1
fi

# =============================================================================
# Check 6: CI/CD Config Changed
# =============================================================================

if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '^\.github/workflows/|^\.gitlab-ci\.yml$|^\.circleci/|^Jenkinsfile$'; then
    echo "ğŸ”„ CI/CD configuration changed!"
    echo "   Review pipeline changes"
    echo ""
    CHANGES_DETECTED=1
fi

# =============================================================================
# Check 7: Schema/Model Changes
# =============================================================================

if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep -qE '^app/models/|^models/|^schema/|^prisma/schema\.prisma$'; then
    echo "ğŸ“‹ Schema/Model files changed!"
    echo "   Database schema may need updating"
    echo ""
    CHANGES_DETECTED=1
fi

# =============================================================================
# Summary
# =============================================================================

if [ $CHANGES_DETECTED -eq 0 ]; then
    echo "âœ… No dependency or configuration changes detected"
else
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "â„¹ï¸  Review the changes above and take necessary actions"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
fi

echo ""
exit 0
