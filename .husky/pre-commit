#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# Pre-commit Hook - Developer Friendly Version
# =============================================================================
# - All checks have timeouts
# - Non-critical checks are warnings only
# - Can be skipped with: git commit --no-verify
# - Detailed output for debugging
# =============================================================================

set +e  # Don't exit on first error - collect all issues

ERRORS=0
WARNINGS=0
TIMEOUT_SECONDS=30

echo "ğŸ” Running pre-commit checks..."
echo ""

# =============================================================================
# Helper Functions
# =============================================================================

run_with_timeout() {
    local timeout=$1
    shift
    local description=$1
    shift
    
    if command -v timeout >/dev/null 2>&1; then
        timeout "$timeout" "$@"
    elif command -v gtimeout >/dev/null 2>&1; then
        gtimeout "$timeout" "$@"
    else
        # No timeout available, run normally
        "$@"
    fi
    
    local exit_code=$?
    
    if [ $exit_code -eq 124 ] || [ $exit_code -eq 143 ]; then
        echo "â±ï¸  $description timed out after ${timeout}s (continuing...)"
        return 0
    fi
    
    return $exit_code
}

warn() {
    echo "âš ï¸  $1"
    WARNINGS=$((WARNINGS + 1))
}

error() {
    echo "âŒ $1"
    ERRORS=$((ERRORS + 1))
}

# =============================================================================
# Check 1: Registry Sync (CRITICAL)
# =============================================================================

if git diff --cached --name-only | grep -qE '^(scripts/registry\.json|rsr)$'; then
    echo "ğŸ“‹ Checking registry.json sync..."
    
    if run_with_timeout $TIMEOUT_SECONDS "Registry sync" bash tools/build-registry.sh --check 2>/dev/null; then
        echo "âœ… Registry is in sync"
    else
        error "Registry is out of sync!"
        echo ""
        echo "   To fix, run: make build-registry"
        echo "   Or skip: git commit --no-verify"
        echo ""
    fi
fi

# =============================================================================
# Check 2: Shell Script Syntax (CRITICAL)
# =============================================================================

echo "ğŸš Checking shell script syntax..."
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)

if [ -n "$STAGED_SH_FILES" ]; then
    SYNTAX_ERRORS=0
    SKIPPED_FILES=0
    for file in $STAGED_SH_FILES; do
        if [ -f "$file" ]; then
            # Detect shell type from shebang
            shebang=$(head -n 1 "$file")
            shell_cmd="bash"
            
            # Skip non-shell scripts (e.g., Python, Node.js with .sh extension)
            if [[ "$shebang" =~ "python" ]] || [[ "$shebang" =~ "node" ]] || [[ "$shebang" =~ "ruby" ]] || [[ "$shebang" =~ "perl" ]]; then
                SKIPPED_FILES=$((SKIPPED_FILES + 1))
                continue
            fi
            
            if [[ "$shebang" =~ "zsh" ]]; then
                shell_cmd="zsh"
            elif [[ "$shebang" =~ "bash" ]]; then
                shell_cmd="bash"
            elif [[ "$shebang" =~ "sh" ]]; then
                shell_cmd="sh"
            fi
            
            # Check if the shell is available
            if ! command -v "$shell_cmd" >/dev/null 2>&1; then
                warn "Cannot check $file: $shell_cmd not available"
                continue
            fi
            
            # Check syntax with appropriate interpreter
            if ! "$shell_cmd" -n "$file" 2>/dev/null; then
                error "Syntax error in: $file"
                SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
            fi
        fi
    done
    
    if [ $SYNTAX_ERRORS -eq 0 ]; then
        echo "âœ… All shell scripts have valid syntax"
        [ $SKIPPED_FILES -gt 0 ] && echo "â„¹ï¸  Skipped $SKIPPED_FILES non-shell script(s) with .sh extension"
    fi
else
    echo "â„¹ï¸  No shell scripts to check"
fi

# =============================================================================
# Check 3: PowerShell Script Syntax (WARNING ONLY)
# =============================================================================

echo "ğŸ’» Checking PowerShell script syntax..."
STAGED_PS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.ps1$' || true)

if [ -n "$STAGED_PS_FILES" ]; then
    if command -v pwsh >/dev/null 2>&1; then
        PS_ERRORS=0
        for file in $STAGED_PS_FILES; do
            if [ -f "$file" ]; then
                if ! run_with_timeout 10 "PowerShell syntax" pwsh -NoProfile -Command "
                    try {
                        \$null = [System.Management.Automation.PSParser]::Tokenize((Get-Content '$file' -Raw), [ref]\$null)
                        exit 0
                    } catch {
                        exit 1
                    }
                " 2>/dev/null; then
                    warn "PowerShell syntax issue in: $file"
                    PS_ERRORS=$((PS_ERRORS + 1))
                fi
            fi
        done
        
        if [ $PS_ERRORS -eq 0 ]; then
            echo "âœ… All PowerShell scripts have valid syntax"
        fi
    else
        echo "â„¹ï¸  PowerShell not installed (skipping)"
    fi
else
    echo "â„¹ï¸  No PowerShell scripts to check"
fi

# =============================================================================
# Check 4: JSON Validation (WARNING ONLY)
# =============================================================================

echo "ğŸ“„ Validating JSON files..."
STAGED_JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.json$' || true)

if [ -n "$STAGED_JSON_FILES" ]; then
    JSON_ERRORS=0
    for file in $STAGED_JSON_FILES; do
        if [ -f "$file" ]; then
            if ! python3 -m json.tool "$file" >/dev/null 2>&1; then
                warn "Invalid JSON in: $file"
                JSON_ERRORS=$((JSON_ERRORS + 1))
            fi
        fi
    done
    
    if [ $JSON_ERRORS -eq 0 ]; then
        echo "âœ… All JSON files are valid"
    fi
else
    echo "â„¹ï¸  No JSON files to check"
fi

# =============================================================================
# Check 5: YAML Validation (WARNING ONLY)
# =============================================================================

echo "ğŸ“„ Validating YAML files..."
STAGED_YAML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yml|yaml)$' || true)

if [ -n "$STAGED_YAML_FILES" ]; then
    if command -v yamllint >/dev/null 2>&1; then
        YAML_ERRORS=0
        for file in $STAGED_YAML_FILES; do
            if [ -f "$file" ]; then
                if ! run_with_timeout 5 "YAML validation" yamllint -c .yamllint.yml "$file" 2>/dev/null; then
                    warn "YAML issues in: $file (run 'yamllint $file' for details)"
                    YAML_ERRORS=$((YAML_ERRORS + 1))
                fi
            fi
        done
        
        if [ $YAML_ERRORS -eq 0 ]; then
            echo "âœ… All YAML files are valid"
        fi
    else
        echo "â„¹ï¸  yamllint not installed (skipping)"
    fi
else
    echo "â„¹ï¸  No YAML files to check"
fi

# =============================================================================
# Check 6: Trailing Whitespace (AUTO-FIX)
# =============================================================================

echo "ğŸ”§ Checking trailing whitespace..."
STAGED_TEXT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -vE '\.(png|jpg|jpeg|gif|ico|pdf|zip|tar|gz|bz2|xz|7z|rar|exe|dll|so|dylib|bin|dat)$' || true)

if [ -n "$STAGED_TEXT_FILES" ]; then
    FIXED=0
    for file in $STAGED_TEXT_FILES; do
        if [ -f "$file" ]; then
            if grep -q '[[:space:]]$' "$file" 2>/dev/null; then
                # Auto-fix trailing whitespace
                sed -i '' 's/[[:space:]]*$//' "$file" 2>/dev/null || sed -i 's/[[:space:]]*$//' "$file" 2>/dev/null
                git add "$file"
                FIXED=$((FIXED + 1))
            fi
        fi
    done
    
    if [ $FIXED -gt 0 ]; then
        echo "âœ… Fixed trailing whitespace in $FIXED file(s)"
    else
        echo "âœ… No trailing whitespace found"
    fi
else
    echo "â„¹ï¸  No text files to check"
fi

# =============================================================================
# Check 7: Large Files (WARNING ONLY)
# =============================================================================

echo "ğŸ“¦ Checking for large files..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read -r file; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 524288 ]; then  # 512KB
            echo "$file ($((size / 1024))KB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    warn "Large files detected:"
    echo "$LARGE_FILES" | while read -r line; do
        echo "     $line"
    done
    echo "   Consider using Git LFS for large files"
else
    echo "âœ… No large files detected"
fi

# =============================================================================
# Check 8: Debug Code (WARNING ONLY)
# =============================================================================

echo "ğŸ› Checking for debug code..."
STAGED_CODE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|ps1|js|py|rb|php|java|go|rs)$' || true)

if [ -n "$STAGED_CODE_FILES" ]; then
    DEBUG_FOUND=0
    for file in $STAGED_CODE_FILES; do
        if [ -f "$file" ]; then
            if grep -nE '(console\.log|debugger|var_dump|print_r|binding\.pry|byebug|set -x|\bdd\b|\bdebug\b.*=.*true)' "$file" 2>/dev/null | head -3; then
                warn "Possible debug code in: $file"
                DEBUG_FOUND=$((DEBUG_FOUND + 1))
            fi
        fi
    done
    
    if [ $DEBUG_FOUND -eq 0 ]; then
        echo "âœ… No obvious debug code found"
    fi
else
    echo "â„¹ï¸  No code files to check"
fi

# =============================================================================
# Summary
# =============================================================================

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

if [ $ERRORS -gt 0 ]; then
    echo "âŒ Pre-commit checks failed with $ERRORS error(s)"
    if [ $WARNINGS -gt 0 ]; then
        echo "âš ï¸  Also found $WARNINGS warning(s) (non-blocking)"
    fi
    echo ""
    echo "To skip these checks: git commit --no-verify"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo "âš ï¸  Pre-commit checks passed with $WARNINGS warning(s)"
    echo "   Review warnings above, but commit can proceed"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 0
else
    echo "âœ… All pre-commit checks passed!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 0
fi
