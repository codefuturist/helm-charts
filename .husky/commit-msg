#!/usr/bin/env sh
# shellcheck disable=SC1091
. "$(dirname -- "$0")/_/husky.sh"

# =============================================================================
# Commit Message Hook - Developer Friendly Version
# =============================================================================
# - Validates commit message format using commitizen (if available) or regex
# - Non-blocking warnings for suggestions
# =============================================================================

COMMIT_MSG_FILE=$1

# Read the commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip if merge commit
if echo "$COMMIT_MSG" | grep -q "^Merge"; then
    exit 0
fi

# Skip if revert commit
if echo "$COMMIT_MSG" | grep -q "^Revert"; then
    exit 0
fi

echo "üìù Validating commit message..."

# =============================================================================
# Check: Use Commitizen if available, otherwise fallback to regex
# =============================================================================

# Find commitizen (prefer pipx installation to avoid conflicts with git aliases)
CZ_CMD=""
if [ -x "$HOME/.local/bin/cz" ]; then
    CZ_CMD="$HOME/.local/bin/cz"
elif command -v cz >/dev/null 2>&1 && cz version >/dev/null 2>&1; then
    CZ_CMD="cz"
fi

if [ -n "$CZ_CMD" ]; then
    # Use commitizen for validation (non-blocking)
    if ! $CZ_CMD check --commit-msg-file "$COMMIT_MSG_FILE" 2>/dev/null; then
        echo ""
        echo "‚ö†Ô∏è  Commit message doesn't follow Conventional Commits format"
        echo ""
        echo "   üí° Tip: Use 'make commit' or '$CZ_CMD commit' for an interactive guide"
        echo ""
        echo "   Your message:"
        echo "   $COMMIT_MSG"
        echo ""
        echo "   ‚ÑπÔ∏è  This is just a suggestion - commit will proceed"
        echo ""
    fi
else
    # Fallback: Regex-based validation (WARNING ONLY)
    # Pattern: type(scope): subject
    if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}'; then
        echo ""
        echo "‚ö†Ô∏è  Commit message doesn't follow Conventional Commits format"
        echo ""
        echo "   Recommended format:"
        echo "   <type>(<scope>): <subject>"
        echo ""
        echo "   Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore"
        echo ""
        echo "   Example:"
        echo "   feat(ssh): add key management"
        echo "   fix(backup): correct rsync flags"
        echo ""
        echo "   üí° Tip: Install commitizen for interactive commits:"
        echo "      pipx install commitizen"
        echo "      cz commit"
        echo ""
        echo "   Your message:"
        echo "   $COMMIT_MSG"
        echo ""
        echo "   ‚ÑπÔ∏è  This is just a suggestion - commit will proceed"
        echo ""
    fi
fi

# =============================================================================
# Check: Message Length (WARNING ONLY)
# =============================================================================

SUBJECT_LINE=$(echo "$COMMIT_MSG" | head -1)
SUBJECT_LENGTH=${#SUBJECT_LINE}

if [ "$SUBJECT_LENGTH" -gt 72 ]; then
    echo "‚ö†Ô∏è  Commit subject is $SUBJECT_LENGTH characters (recommended: ‚â§72)"
    echo "   Consider shortening the first line"
    echo ""
fi

if [ "$SUBJECT_LENGTH" -lt 10 ]; then
    echo "‚ö†Ô∏è  Commit subject is very short ($SUBJECT_LENGTH characters)"
    echo "   Consider adding more context"
    echo ""
fi

# =============================================================================
# Check: WIP Commits (WARNING ONLY)
# =============================================================================

if echo "$COMMIT_MSG" | grep -qiE '^(wip|fixup|squash|tmp|temp)'; then
    echo "‚ö†Ô∏è  WIP-style commit detected"
    echo "   Remember to squash before pushing to main"
    echo ""
fi

# =============================================================================
# Check: Jira/Issue References (INFO ONLY)
# =============================================================================

if echo "$COMMIT_MSG" | grep -qE '#[0-9]+|[A-Z]+-[0-9]+'; then
    echo "‚úÖ Issue reference found"
else
    # Info only - don't warn
    :
fi

echo "‚úÖ Commit message validation complete"
exit 0
